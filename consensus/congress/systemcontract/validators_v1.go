package systemcontract

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
	"math"
	"math/big"
)

var (
	//TODO: set these to formal addresses
	validatorV1Admin        = common.HexToAddress("0x8Cc5A1a0802DB41DB826C2FcB72423744338DcB0")
	validatorV1AdminTestnet = common.HexToAddress("0x8Cc5A1a0802DB41DB826C2FcB72423744338DcB0")
)

const (
	validatorV1Code = "0x6080604052600436106200022a5760003560e01c80638fffcbd01162000127578063bcecf81b11620000af578063ec0cb3361162000079578063ec0cb33614620002f6578063f04a5dcd14620008d1578063f3b1cc6714620002f6578063f40f0f521462000902578063f851a4401462000939576200022a565b8063bcecf81b1462000852578063c885bc581462000880578063c967f90f1462000898578063d6c0edad14620008c7576200022a565b8063a4e98b8211620000f1578063a4e98b821462000773578063afeea11514620007d1578063bb8b65af14620007e9578063bbc716801462000801576200022a565b80638fffcbd014620006e25780639001eed8146200072b5780639cc02c3014620007435780639de70258146200075b576200022a565b80635274ac3f11620001b75780636846992a11620001815780636846992a14620005aa57806371a1bb75146200066357806371df7678146200067b578063741579b114620006935780638f28397014620006ab576200022a565b80635274ac3f14620003895780635dd0959014620004d257806360544bf1146200050957806365f69f971462000573576200022a565b80631c0ffaa211620001f95780631c0ffaa214620002b75780632e4f67e414620002f65780633a82fd5e146200030e57806344f999001462000355576200022a565b806303fab4f6146200022f578063136ec0b31462000259578063158ef93e146200027357806315de360e146200029f575b600080fd5b3480156200023c57600080fd5b506200024762000951565b60408051918252519081900360200190f35b3480156200026657600080fd5b50620002716200095d565b005b3480156200028057600080fd5b506200028b62000ba8565b604080519115158252519081900360200190f35b348015620002ac57600080fd5b506200024762000bb1565b348015620002c457600080fd5b506200027160048036036040811015620002dd57600080fd5b506001600160a01b038135169060200135151562000bb6565b3480156200030357600080fd5b506200024762000cd6565b3480156200031b57600080fd5b506200033f600480360360208110156200033457600080fd5b503560ff1662000cdb565b6040805160ff9092168252519081900360200190f35b3480156200036257600080fd5b506200036d62000cf0565b604080516001600160a01b039092168252519081900360200190f35b3480156200039657600080fd5b506200027160048036036060811015620003af57600080fd5b810190602081018135640100000000811115620003cb57600080fd5b820183602082011115620003de57600080fd5b803590602001918460208302840111640100000000831117156200040157600080fd5b91908080602002602001604051908101604052809392919081815260200183836020028082843760009201919091525092959493602081019350359150506401000000008111156200045257600080fd5b8201836020820111156200046557600080fd5b803590602001918460208302840111640100000000831117156200048857600080fd5b919080806020026020016040519081016040528093929190818152602001838360200280828437600092019190915250929550505090356001600160a01b0316915062000cf69050565b348015620004df57600080fd5b506200027160048036036020811015620004f857600080fd5b50356001600160a01b0316620010ed565b3480156200051657600080fd5b506200052162001167565b60408051602080825283518183015283519192839290830191858101910280838360005b838110156200055f57818101518382015260200162000545565b505050509050019250505060405180910390f35b3480156200058057600080fd5b506200036d600480360360208110156200059957600080fd5b50356001600160a01b0316620011cb565b348015620005b757600080fd5b506200027160048036036040811015620005d057600080fd5b810190602081018135640100000000811115620005ec57600080fd5b820183602082011115620005ff57600080fd5b803590602001918460208302840111640100000000831117156200062257600080fd5b9190808060200260200160405190810160405280939291908181526020018383602002808284376000920191909152509295505091359250620011e6915050565b3480156200067057600080fd5b506200036d62001697565b3480156200068857600080fd5b50620002716200169d565b348015620006a057600080fd5b50620002476200182c565b348015620006b857600080fd5b506200027160048036036020811015620006d157600080fd5b50356001600160a01b031662001838565b348015620006ef57600080fd5b5062000271600480360360808110156200070857600080fd5b5060ff8135811691602081013582169160408201358116916060013516620018e0565b3480156200073857600080fd5b506200024762001b07565b3480156200075057600080fd5b506200024762001b13565b3480156200076857600080fd5b506200052162001b19565b3480156200078057600080fd5b50620007a4600480360360208110156200079957600080fd5b503560ff1662001b7b565b604080516001600160a01b03948516815292909316602083015260ff168183015290519081900360600190f35b348015620007de57600080fd5b506200052162001bad565b348015620007f657600080fd5b506200027162001eb0565b3480156200080e57600080fd5b506200036d600480360360808110156200082757600080fd5b5080356001600160a01b03908116916020810135909116906040810135906060013560ff16620020f6565b3480156200085f57600080fd5b506200036d600480360360208110156200087857600080fd5b5035620022e0565b3480156200088d57600080fd5b506200027162002308565b348015620008a557600080fd5b50620008b062002370565b6040805161ffff9092168252519081900360200190f35b6200027162002375565b348015620008de57600080fd5b506200033f60048036036020811015620008f757600080fd5b503560ff16620027f9565b3480156200090f57600080fd5b5062000247600480360360208110156200092857600080fd5b50356001600160a01b03166200280e565b3480156200094657600080fd5b506200036d62002820565b671bc16d674ec8000081565b6000339050806001600160a01b031660076000836001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b158015620009aa57600080fd5b505afa158015620009bf573d6000803e3d6000fd5b505050506040513d6020811015620009d657600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462000a43576040805162461bcd60e51b8152602060048201526018602482015277159bdd19481c1bdbdb081b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b336001816001600160a01b031663c19d93fb6040518163ffffffff1660e01b815260040160206040518083038186803b15801562000a8057600080fd5b505afa15801562000a95573d6000803e3d6000fd5b505050506040513d602081101562000aac57600080fd5b5051600381111562000aba57fe5b1462000aff576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600060096000836001600160a01b031663683c529c6040518163ffffffff1660e01b815260040160206040518083038186803b15801562000b3f57600080fd5b505afa15801562000b54573d6000803e3d6000fd5b505050506040513d602081101562000b6b57600080fd5b5051600181111562000b7957fe5b600181111562000b8557fe5b81526020810191909152604001600020905062000ba3818362002834565b505050565b60005460ff1681565b60c881565b60005461010090046001600160a01b0316331462000c08576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b6001600160a01b038281166000908152600760205260409020541662000c605760405162461bcd60e51b815260040180806020018281038252602181526020018062005d326021913960400191505060405180910390fd5b6001600160a01b03808316600090815260076020526040808220548151638ec7a23d60e01b815285151560048201529151931692638ec7a23d9260248084019391929182900301818387803b15801562000cb957600080fd5b505af115801562000cce573d6000803e3d6000fd5b505050505050565b606481565b60016020526000908152604090205460ff1681565b61f00681565b60005460ff161562000d45576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b6000835111801562000d58575081518351145b62000d9b576040805162461bcd60e51b815260206004820152600e60248201526d496e76616c696420706172616d7360901b604482015290519081900360640190fd5b6001600160a01b03811662000def576040805162461bcd60e51b8152602060048201526015602482015274496e76616c69642061646d696e206164647265737360581b604482015290519081900360640190fd5b60008054600160ff199091168117610100600160a81b0319166101006001600160a01b038516021782558180600181111562000e2757fe5b815260200190815260200160002060006101000a81548160ff021916908360ff16021790555060156001600060018081111562000e6057fe5b600181111562000e6c57fe5b81526020808201929092526040016000908120805460ff9490941660ff1994851617905560029091527fac33ff75c19e70fe83507db0d683fd3465c996598dc972688b7ace676c89077b805483169055600181527fe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e080549092169091555b83518160ff161015620010e7576000848260ff168151811062000f0957fe5b6020908102919091018101516001600160a01b0380821660009081526007909352604090922054909250161562000f83576040805162461bcd60e51b815260206004820152601960248201527856616c696461746f727320616c72656164792065786973747360381b604482015290519081900360640190fd5b600081858460ff168151811062000f9657fe5b60200260200101516103e860018060405162000fb2906200360a565b80866001600160a01b03168152602001856001600160a01b0316815260200184815260200183600181111562000fe457fe5b815260200182600381111562000ff657fe5b815260200195505050505050604051809103906000f0801580156200101f573d6000803e3d6000fd5b5060068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b038086166001600160a01b031992831681179093556000928352600760205260408084208054928616929093168217909255815163204a7f0760e21b8152915193945092638129fc1c9260048084019391929182900301818387803b158015620010bf57600080fd5b505af1158015620010d4573d6000803e3d6000fd5b50506001909401935062000eea92505050565b50505050565b3361f006146200113b576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b6001600160a01b0390811660009081526007602090815260408083205490931682526008905290812055565b60606004805480602002602001604051908101604052809291908181526020018280548015620011c157602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620011a2575b5050505050905090565b6007602052600090815260409020546001600160a01b031681565b33411462001228576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600a60209081526040808320600180855292529091205460ff16156200128e576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481bdc195c985d195960821b604482015290519081900360640190fd5b818043816200129957fe5b0615620012e0576040805162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015290519081900360640190fd5b60005460ff1662001327576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b436000908152600a60209081526040808320600180855292528220805460ff191690911790555b60035460ff82161015620013b35760006005600060038460ff16815481106200137357fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805460ff191660ff929092169190911790556001016200134e565b508351620013c990600390602087019062003618565b5060005b60035460ff82161015620014325760016005600060038460ff1681548110620013f257fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805460ff191660ff92909216919091179055600101620013cd565b50620014416004600062003682565b6200144b620036a5565b50604080518082019091526000808252600160208301525b60028160ff16101562000cce57600060026000848460ff16600281106200148657fe5b602002015160018111156200149757fe5b6001811115620014a357fe5b815260200190815260200160002060009054906101000a900460ff169050600060096000858560ff1660028110620014d757fe5b60200201516001811115620014e857fe5b6001811115620014f457fe5b8152602081019190915260400160002080549091506001600160a01b03165b60008360ff161180156200152f57506001600160a01b03811615155b156200168b5760056000826001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b1580156200157357600080fd5b505afa15801562001588573d6000803e3d6000fd5b505050506040513d60208110156200159f57600080fd5b50516001600160a01b0316815260208101919091526040016000205460ff1662001668576004816001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b158015620015ff57600080fd5b505afa15801562001614573d6000803e3d6000fd5b505050506040513d60208110156200162b57600080fd5b505181546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b0390921691909117905560001992909201915b6001600160a01b0390811660009081526003830160205260409020541662001513565b50505060010162001463565b61f00581565b6000339050806001600160a01b031660076000836001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b158015620016ea57600080fd5b505afa158015620016ff573d6000803e3d6000fd5b505050506040513d60208110156200171657600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462001783576040805162461bcd60e51b8152602060048201526018602482015277159bdd19481c1bdbdb081b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b6000339050600060096000836001600160a01b031663683c529c6040518163ffffffff1660e01b815260040160206040518083038186803b158015620017c857600080fd5b505afa158015620017dd573d6000803e3d6000fd5b505050506040513d6020811015620017f457600080fd5b505160018111156200180257fe5b60018111156200180e57fe5b81526020810191909152604001600020905062000ba3818362002df3565b670de0b6b3a764000081565b60005461010090046001600160a01b031633146200188a576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60008054610100600160a81b0319166101006001600160a01b03848116820292909217808455604051919004909116917f927cc064d7b7fa546fa7706bc01845d27d06f15af3ae90a672cc44735928e96191a250565b60005461010090046001600160a01b0316331462001932576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60ff848301166015146200198d576040805162461bcd60e51b815260206004820152601860248201527f496e76616c69642076616c696461746f7220636f756e74730000000000000000604482015290519081900360640190fd5b8360ff168360ff1611158015620019aa57508160ff168160ff1611155b620019f4576040805162461bcd60e51b8152602060048201526015602482015274496e76616c6964206261636b757020636f756e747360581b604482015290519081900360640190fd5b7fa6eef7e35abe7026729641147f7915573c7e97b47efa546f5f6e3230263bcb49805460ff86811660ff1992831681179093557fcc69885fda6bcc1a4ace058b4a62bf5e179ea78fd58a1ccd71c22cc9b688792f80548683169084168117909155600260209081527fac33ff75c19e70fe83507db0d683fd3465c996598dc972688b7ace676c89077b8054851689851690811790915560016000527fe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e080549095169387169384179094556040805195865290850193909352838301526060830152517fef8fc40942f0314a9f5ebd7832ff1b78e6c4b5b7062355066b0c0e3e0edc6f29916080908290030190a150505050565b6729a2241af62c000081565b60065490565b60606003805480602002602001604051908101604052809291908181526020018280548015620011c1576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311620011a2575050505050905090565b600960205260009081526040902080546001909101546001600160a01b0391821691811690600160a01b900460ff1683565b6060600062001bbb620036a5565b50604080518082019091526000808252600160208301525b60028160ff16101562001cce576000828260ff166002811062001bf257fe5b6020020151905060006009600083600181111562001c0c57fe5b600181111562001c1857fe5b815260200190815260200160002090506001600083600181111562001c3957fe5b600181111562001c4557fe5b8152602081019190915260400160002054600182015460ff918216600160a01b909104909116101562001c8c576001810154600160a01b900460ff16949094019362001cc3565b6001600083600181111562001c9d57fe5b600181111562001ca957fe5b815260208101919091526040016000205460ff1694909401935b505060010162001bd3565b5060608260ff1667ffffffffffffffff8111801562001cec57600080fd5b5060405190808252806020026020018201604052801562001d17578160200160208202803683370190505b5090506000805b60028160ff16101562001ea6576000848260ff166002811062001d3d57fe5b6020020151905060006009600083600181111562001d5757fe5b600181111562001d6357fe5b8152602001908152602001600020905060006001600084600181111562001d8657fe5b600181111562001d9257fe5b8152602081019190915260400160002054825460ff90911691506001600160a01b03165b60008260ff1611801562001dd257506001600160a01b03811615155b1562001e9557806001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b15801562001e1257600080fd5b505afa15801562001e27573d6000803e3d6000fd5b505050506040513d602081101562001e3e57600080fd5b50518751889060ff891690811062001e5257fe5b6001600160a01b03928316602091820292909201810191909152918116600090815260038501909252604090912054600190960195600019909201911662001db6565b50506001909201915062001d1e9050565b5090935050505090565b6000339050806001600160a01b031660076000836001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b15801562001efd57600080fd5b505afa15801562001f12573d6000803e3d6000fd5b505050506040513d602081101562001f2957600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462001f96576040805162461bcd60e51b8152602060048201526018602482015277159bdd19481c1bdbdb081b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b336001816001600160a01b031663c19d93fb6040518163ffffffff1660e01b815260040160206040518083038186803b15801562001fd357600080fd5b505afa15801562001fe8573d6000803e3d6000fd5b505050506040513d602081101562001fff57600080fd5b505160038111156200200d57fe5b1462002052576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600060096000836001600160a01b031663683c529c6040518163ffffffff1660e01b815260040160206040518083038186803b1580156200209257600080fd5b505afa158015620020a7573d6000803e3d6000fd5b505050506040513d6020811015620020be57600080fd5b50516001811115620020cc57fe5b6001811115620020d857fe5b81526020810191909152604001600020905062000ba3818362002fe8565b6000805461010090046001600160a01b0316331462002149576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b6001600160a01b038581166000908152600760205260409020541615620021b3576040805162461bcd60e51b815260206004820152601960248201527856616c696461746f727320616c72656164792065786973747360381b604482015290519081900360640190fd5b6000858585856000604051620021c9906200360a565b80866001600160a01b03168152602001856001600160a01b03168152602001848152602001836001811115620021fb57fe5b81526020018260038111156200220d57fe5b815260200195505050505050604051809103906000f08015801562002236573d6000803e3d6000fd5b5060068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b03808a166001600160a01b03199283168117909355600083815260076020908152604091829020805493871693909416831790935580519182525193945091927f1ab57f2e2a6e4069160cc6501d8012d93ed435770b1ed646f82482a2f7234ff49281900390910190a295945050505050565b60068181548110620022ee57fe5b6000918252602090912001546001600160a01b0316905081565b33600090815260086020526040902054806200232557506200236e565b336000818152600860205260408082208290558051600162c261b160e01b03198152905163ff3d9e4f9285926004808201939182900301818588803b15801562000cb957600080fd5b565b601581565b334114620023b7576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600a6020908152604080832083805290915281205460ff16156200241b576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481bdc195c985d195960821b604482015290519081900360640190fd5b60005460ff1662002462576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b436000908152600a602090815260408083208380529091529020805460ff191660011790556004543490156200256957600454600090620024b490620024ad60648134600a620033bc565b9062003423565b905060005b60045460ff82161015620025475760006007600060048460ff1681548110620024de57fe5b60009182526020808320909101546001600160a01b0390811684528382019490945260409283018220549093168082526008909352205490915062002524908462003467565b6001600160a01b03909116600090815260086020526040902055600101620024b9565b5060045462002565906200255d908390620033bc565b8390620034c2565b9150505b60035415620027f5576000805b60035460ff821610156200263d57620026326007600060038460ff16815481106200259d57fe5b60009182526020808320909101546001600160a01b03908116845283820194909452604092830190912054825163f1cea4c760e01b8152925193169263f1cea4c7926004808201939291829003018186803b158015620025fc57600080fd5b505afa15801562002611573d6000803e3d6000fd5b505050506040513d60208110156200262857600080fd5b5051839062003467565b915060010162002576565b5060008082116200265057600062002663565b620026636064620024ad346028620033bc565b6003549091506000906200267d90620024ad8685620034c2565b905060005b60035460ff8216101562000cce5760006007600060038460ff1681548110620026a757fe5b60009182526020808320909101546001600160a01b0390811684529083019390935260409091019020541690508415620027ac5760006200275686620024ad87856001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b1580156200272157600080fd5b505afa15801562002736573d6000803e3d6000fd5b505050506040513d60208110156200274d57600080fd5b505190620033bc565b6001600160a01b0383166000908152600860205260409020549091506200278c90859062002785908462003467565b9062003467565b6001600160a01b03831660009081526008602052604090205550620027eb565b6001600160a01b038116600090815260086020526040902054620027d1908462003467565b6001600160a01b0382166000908152600860205260409020555b5060010162002682565b5050565b60026020526000908152604090205460ff1681565b60086020526000908152604090205481565b60005461010090046001600160a01b031681565b6001820154600160a01b900460ff16620028995781546001600160a01b0382166001600160a01b0319918216811784556001808501805460ff600160a01b91909516909317838104851690920190931690910260ff60a01b19909116179055620027f5565b81546001600160a01b0382811691161415620028b557620027f5565b6001600160a01b038082166000908152600284016020526040902054168062002a5e576001808401805460ff600160a01b80830482169094011690920260ff60a01b1990921691909117908190556040805163f1cea4c760e01b815290516001600160a01b039092169163f1cea4c791600480820192602092909190829003018186803b1580156200294657600080fd5b505afa1580156200295b573d6000803e3d6000fd5b505050506040513d60208110156200297257600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b158015620029b557600080fd5b505afa158015620029ca573d6000803e3d6000fd5b505050506040513d6020811015620029e157600080fd5b50511162002a4957506001820180546001600160a01b038381166000818152600287016020908152604080832080549686166001600160a01b0319978816179055865490941682526003880190529190912080548316821790558254909116179055620027f5565b5060018201546001600160a01b031662002bf5565b806001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b15801562002a9857600080fd5b505afa15801562002aad573d6000803e3d6000fd5b505050506040513d602081101562002ac457600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b15801562002b0757600080fd5b505afa15801562002b1c573d6000803e3d6000fd5b505050506040513d602081101562002b3357600080fd5b50511162002b425750620027f5565b6001600160a01b038083166000818152600386016020526040808220548585168352912080546001600160a01b0319169184169190911790556001850154909116141562002bad576001830180546001600160a01b0319166001600160a01b03831617905562002bf5565b6001600160a01b03808316600090815260028501602081815260408084205460038901835281852054861685529290915290912080546001600160a01b031916919092161790555b6001600160a01b0381161580159062002ce25750806001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b15801562002c4357600080fd5b505afa15801562002c58573d6000803e3d6000fd5b505050506040513d602081101562002c6f57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b15801562002cb257600080fd5b505afa15801562002cc7573d6000803e3d6000fd5b505050506040513d602081101562002cde57600080fd5b5051115b1562002d0b576001600160a01b0390811660009081526002840160205260409020541662002bf5565b6001600160a01b03811662002d815782546001600160a01b038381166000818152600387016020908152604080832080549686166001600160a01b031997881617905588549094168252600288019052828120805485168317905581815291909120805483169055845490911617835562000ba3565b6001600160a01b0390811660008181526003850160209081526040808320805496861680855282852080549888166001600160a01b0319998a16179055815490961684526002909701909152808220805486168517905585548516841790955591825292902080549091169091179055565b81546001600160a01b0382811691161480159062002e2b57506001600160a01b03818116600090815260028401602052604090205416155b1562002e3757620027f5565b60018201546001600160a01b038281169116141562002e84576001600160a01b0380821660009081526002840160205260409020546001840180546001600160a01b031916919092161790555b81546001600160a01b038281169116141562002ec8576001600160a01b03808216600090815260038401602052604090205483546001600160a01b03191691161782555b6001600160a01b03808216600090815260038401602052604090205416801562002f24576001600160a01b038083166000908152600285016020526040808220548484168352912080546001600160a01b031916919092161790555b6001600160a01b03808316600090815260028501602052604090205416801562002f80576001600160a01b038084166000908152600386016020526040808220548484168352912080546001600160a01b031916919092161790555b50506001600160a01b03166000908152600282016020908152604080832080546001600160a01b03199081169091556003850190925290912080549091169055600101805460ff60a01b198116600160a01b9182900460ff9081166000190116909102179055565b6001600160a01b0380821660008181526003850160205260409020546001850154908316921614806200302257506001600160a01b038116155b80620031035750816001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b1580156200306357600080fd5b505afa15801562003078573d6000803e3d6000fd5b505050506040513d60208110156200308f57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0384169163f1cea4c7916004808301926020929190829003018186803b158015620030d257600080fd5b505afa158015620030e7573d6000803e3d6000fd5b505050506040513d6020811015620030fe57600080fd5b505111155b15620031105750620027f5565b6001600160a01b038083166000818152600286016020526040808220548585168352912080546001600160a01b03191691841691909117905584549091161415620031745782546001600160a01b0319166001600160a01b038216178355620031b6565b6001600160a01b0382811660009081526002850160209081526040808320548416835260038701909152902080546001600160a01b0319169183169190911790555b6001600160a01b03811615801590620032a35750816001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b1580156200320457600080fd5b505afa15801562003219573d6000803e3d6000fd5b505050506040513d60208110156200323057600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0384169163f1cea4c7916004808301926020929190829003018186803b1580156200327357600080fd5b505afa15801562003288573d6000803e3d6000fd5b505050506040513d60208110156200329f57600080fd5b5051115b15620032cc576001600160a01b03908116600090815260038401602052604090205416620031b6565b6001600160a01b03811662003344576001830180546001600160a01b038481166000818152600288016020908152604080832080549686166001600160a01b031997881617905560038a0190915280822080548616905585549093168152919091208054831682179055825490911617905562000ba3565b6001600160a01b0390811660008181526002850160208181526040808420805487168552600390980180835281852080546001600160a01b0319908116998916998a17909155848452895489875283872080549190991690821617909755825283208054861685179055929091529052825416179055565b600082620033cd575060006200341d565b82820282848281620033db57fe5b04146200341a5760405162461bcd60e51b815260040180806020018281038252602181526020018062005d116021913960400191505060405180910390fd5b90505b92915050565b60006200341a83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003506565b6000828201838110156200341a576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b60006200341a83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250620035ad565b60008183620035965760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b838110156200355a57818101518382015260200162003540565b50505050905090810190601f168015620035885780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b506000838581620035a357fe5b0495945050505050565b60008184841115620036025760405162461bcd60e51b81526020600482018181528351602484015283519092839260449091019190850190808383600083156200355a57818101518382015260200162003540565b505050900390565b61261580620036fc83390190565b82805482825590600052602060002090810192821562003670579160200282015b828111156200367057825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003639565b506200367e929150620036c3565b5090565b5080546000825590600052602060002090810190620036a29190620036e4565b50565b60405180604001604052806002906020820280368337509192915050565b5b808211156200367e5780546001600160a01b0319168155600101620036c4565b5b808211156200367e5760008155600101620036e556fe60806040523480156200001157600080fd5b506040516200261538038062002615833981810160405260a08110156200003757600080fd5b508051602082015160408301516060840151608090940151929391929091903361f00514620000ad576040805162461bcd60e51b815260206004820152601860248201527f56616c696461746f727320636f6e7472616374206f6e6c790000000000000000604482015290519081900360640190fd5b81836001826001811115620000be57fe5b14156200012257600081118015620000d857506103e88111155b6200011c576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b620001ad565b60008111801562000169575062000165600a6200015160036103e86200024560201b62001f961790919060201c565b620002ac60201b62001ff61790919060201c565b8111155b620001ad576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600080546301000000600160b81b03191663010000006001600160a01b038a81169190910291909117808355600180546001600160a01b031916928a16929092178255600388905586929161ff0019909116906101009084908111156200021057fe5b02179055506000805484919062ff00001916620100008360038111156200023357fe5b0217905550505050505050506200039d565b6000826200025657506000620002a6565b828202828482816200026457fe5b0414620002a35760405162461bcd60e51b8152600401808060200182810382526021815260200180620025f46021913960400191505060405180910390fd5b90505b92915050565b6000620002a383836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250620002f660201b60201c565b60008183620003865760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b838110156200034a57818101518382015260200162000330565b50505050905090810190601f168015620003785780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060008385816200039357fe5b0495945050505050565b61224780620003ad6000396000f3fe6080604052600436106102305760003560e01c80638129fc1c1161012e578063c19d93fb116100ab578063f06d5e771161006f578063f06d5e7714610614578063f1cea4c71461063e578063f3b1cc67146102c4578063fef10b9514610653578063ff3d9e4f1461066857610230565b8063c19d93fb146105a6578063c967f90f146105cb578063d0e30db0146105f7578063e9fad8ee146105ff578063ec0cb336146102c457610230565b8063939d6237116100f2578063939d6237146104db5780639e83d5b1146104f0578063a3ec138d14610505578063a3fbbaae1461055e578063a66066791461059157610230565b80638129fc1c1461045b578063826d3dec146104705780638ec7a23d146104855780638f76691a146104b15780639001eed8146104c657610230565b806344f99900116101bc578063683c529c11610180578063683c529c146103bc5780636fb3ab61146103f257806370ba11131461041c57806371a1bb7514610431578063741579b11461044657610230565b806344f999001461034f578063481c6a7514610364578063483a00e8146103795780634df9d6ba1461038157806351e318f5146103b457610230565b80632b8aba7a116102035780632b8aba7a146102af5780632e4f67e4146102c45780633a5381b5146102d95780633ccfd60b1461030a57806341f4ca621461032157610230565b806303fab4f614610235578063158ef93e1461025c57806315de360e1461028557806324c5b1ca1461029a575b600080fd5b34801561024157600080fd5b5061024a610670565b60408051918252519081900360200190f35b34801561026857600080fd5b5061027161067c565b604080519115158252519081900360200190f35b34801561029157600080fd5b5061024a610685565b3480156102a657600080fd5b5061024a61068a565b3480156102bb57600080fd5b5061024a610690565b3480156102d057600080fd5b5061024a610696565b3480156102e557600080fd5b506102ee61069b565b604080516001600160a01b039092168252519081900360200190f35b34801561031657600080fd5b5061031f6106b1565b005b34801561032d57600080fd5b50610336610a22565b6040805192835260208301919091528051918290030190f35b34801561035b57600080fd5b506102ee610a2b565b34801561037057600080fd5b506102ee610a31565b61031f610a40565b34801561038d57600080fd5b5061024a600480360360208110156103a457600080fd5b50356001600160a01b0316610d22565b61031f610d67565b3480156103c857600080fd5b506103d1610ecc565b604051808260018111156103e157fe5b815260200191505060405180910390f35b3480156103fe57600080fd5b5061031f6004803603602081101561041557600080fd5b5035610eda565b34801561042857600080fd5b5061024a610fa4565b34801561043d57600080fd5b506102ee610faa565b34801561045257600080fd5b5061024a610fb0565b34801561046757600080fd5b5061031f610fbc565b34801561047c57600080fd5b5061031f6110b8565b34801561049157600080fd5b5061031f600480360360208110156104a857600080fd5b50351515611254565b3480156104bd57600080fd5b5061024a61145b565b3480156104d257600080fd5b5061024a611461565b3480156104e757600080fd5b5061024a61146d565b3480156104fc57600080fd5b5061031f611473565b34801561051157600080fd5b506105386004803603602081101561052857600080fd5b50356001600160a01b0316611643565b604080519485526020850193909352838301919091526060830152519081900360800190f35b34801561056a57600080fd5b5061031f6004803603602081101561058157600080fd5b50356001600160a01b031661166a565b34801561059d57600080fd5b5061031f611713565b3480156105b257600080fd5b506105bb6118f6565b604051808260038111156103e157fe5b3480156105d757600080fd5b506105e0611905565b6040805161ffff9092168252519081900360200190f35b61031f61190a565b34801561060b57600080fd5b5061031f611b64565b34801561062057600080fd5b5061031f6004803603602081101561063757600080fd5b5035611ce7565b34801561064a57600080fd5b5061024a611e54565b34801561065f57600080fd5b5061024a611e5a565b61031f611e60565b671bc16d674ec8000081565b60005460ff1681565b60c881565b600b5481565b600a5481565b606481565b600054630100000090046001600160a01b031681565b336000908152600760205260409020600301546064906106d2904390612038565b11610719576040805162461bcd60e51b8152602060048201526012602482015271125b9d195c9d985b081d1bdbc81cdb585b1b60721b604482015290519081900360640190fd5b33600090815260076020526040902060020154610778576040805162461bcd60e51b815260206004820152601860248201527756616c75652073686f756c64206e6f74206265207a65726f60401b604482015290519081900360640190fd5b3360009081526007602052604090206002810154905410156107d7576040805162461bcd60e51b8152602060048201526013602482015272125b9cdd59999a58da595b9d08185b5bdd5b9d606a1b604482015290519081900360640190fd5b61f0056001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561081457600080fd5b505af1158015610828573d6000803e3d6000fd5b5050336000908152600760205260408120600181015490546008549294506108709350909161086a91670de0b6b3a76400009161086491611f96565b90611ff6565b90612038565b33600090815260076020526040902060020154600954919250906108949082612038565b600955336000908152600760205260409020546108b19082612038565b3360009081526007602052604090208190556008546108de91670de0b6b3a7640000916108649190611f96565b336000908152600760205260408120600180820193909355600281018290556003015560005462010000900460ff16600381111561091857fe5b14156109745761f0056001600160a01b031663bb8b65af6040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561095b57600080fd5b505af115801561096f573d6000803e3d6000fd5b505050505b8015610a1e57336108fc610988838561207a565b6040518115909202916000818181858888f193505050501580156109b0573d6000803e3d6000fd5b5060408051828152905133917f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364919081900360200190a260408051838152905133917f7cddc560d4de1ea9d83e4123f01e6072afc503bb47bcc765f0396ba3861a0454919081900360200190a25b5050565b60045460055482565b61f00681565b6001546001600160a01b031681565b6001546001600160a01b03163314610a96576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b6000805462010000900460ff166003811115610aae57fe5b1480610aef5750600360005462010000900460ff166003811115610ace57fe5b148015610aef575060c8610aed600a544361203890919063ffffffff16565b115b610b32576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600b541580610b5557506064610b53600b544361203890919063ffffffff16565b115b610ba1576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b60003411610bf1576040805162461bcd60e51b815260206004820152601860248201527756616c75652073686f756c64206e6f74206265207a65726f60401b604482015290519081900360640190fd5b600254610bfe903461207a565b60025560408051348152905133917f278e696bd0cd4a7d1260ced26c40cd01c2b088f441889e4148240ac81069b348919081900360200190a260006001600054610100900460ff166001811115610c5157fe5b1415610c665750670de0b6b3a7640000610c71565b506729a2241af62c00005b8060025410610d1f576000805462ff000019166201000017808255604080516363e1d45160e01b815263010000009092046001600160a01b031660048301525161f006926363e1d451926024808201939182900301818387803b158015610cd757600080fd5b505af1158015610ceb573d6000803e3d6000fd5b505060005462010000900460ff169150506003811115610d0757fe5b6040516000805160206121d183398151915290600090a25b50565b6001600160a01b038116600090815260076020526040812060018101549054600854610d61929161086a91670de0b6b3a7640000916108649190611f96565b92915050565b6001546001600160a01b03163314610dbd576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b61f0056001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610dfa57600080fd5b505af1158015610e0e573d6000803e3d6000fd5b50505050600060065411610e5a576040805162461bcd60e51b815260206004820152600e60248201526d139bc81b5bdc99481c995dd85c9960921b604482015290519081900360640190fd5b600680546000918290556040519091339183156108fc0291849190818181858888f19350505050158015610e92573d6000803e3d6000fd5b5060408051828152905133917f7f8a039147dc0b0622f9bba839240c55ceb9bac5eeb22a874bb4e823a4c1cbc1919081900360200190a250565b600054610100900460ff1681565b60008111610f2a576040805162461bcd60e51b815260206004820152601860248201527756616c75652073686f756c64206e6f74206265207a65726f60401b604482015290519081900360640190fd5b33600090815260076020526040902054811115610f84576040805162461bcd60e51b8152602060048201526013602482015272125b9cdd59999a58da595b9d08185b5bdd5b9d606a1b604482015290519081900360640190fd5b336000908152600760205260409020600281019190915543600390910155565b60035481565b61f00581565b670de0b6b3a764000081565b3361f0051461100d576040805162461bcd60e51b815260206004820152601860248201527756616c696461746f727320636f6e7472616374206f6e6c7960401b604482015290519081900360640190fd5b60005460ff161561105b576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b6000805460ff191660011781556040805163136ec0b360e01b8152905161f0059263136ec0b3926004808201939182900301818387803b15801561109e57600080fd5b505af11580156110b2573d6000803e3d6000fd5b50505050565b3361f00614611105576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b43600a556000805462ff0000191662030000179081905562010000900460ff16600381111561113057fe5b6040516000805160206121d183398151915290600090a261f0056001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561118457600080fd5b505af1158015611198573d6000803e3d6000fd5b505050506000671bc16d674ec8000060025410156111b8576002546111c2565b671bc16d674ec800005b90508015610d1f576002546111d79082612038565b60025560405160009082156108fc0290839083818181858288f19350505050158015611207573d6000803e3d6000fd5b5060005460408051838152905163010000009092046001600160a01b0316917febbcaaf6b9aa8b4083ae4b2f842c8de6f75319018e7b5e141a1e87aebadde6c3916020908290030190a250565b3361f005146112a5576040805162461bcd60e51b815260206004820152601860248201527756616c696461746f727320636f6e7472616374206f6e6c7960401b604482015290519081900360640190fd5b80156113c0576000805462010000900460ff1660038111156112c357fe5b14806112e55750600160005462010000900460ff1660038111156112e357fe5b145b611328576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6000805462ff0000191662020000179081905562010000900460ff16600381111561134f57fe5b6040516000805160206121d183398151915290600090a261f0056001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156113a357600080fd5b505af11580156113b7573d6000803e3d6000fd5b50505050610d1f565b600260005462010000900460ff1660038111156113d957fe5b1461141d576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6000805462ff000019169081905562010000900460ff16600381111561143f57fe5b6040516000805160206121d183398151915290600090a2610d1f565b60025481565b6729a2241af62c000081565b60085481565b6001546001600160a01b031633146114c9576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b6000805462010000900460ff1660038111156114e157fe5b14611525576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b606461153c600b544361203890919063ffffffff16565b11611589576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b6000600254116115d1576040805162461bcd60e51b815260206004820152600e60248201526d27379036b7b9329036b0b933b4b760911b604482015290519081900360640190fd5b600280546000918290556040519091339183156108fc0291849190818181858888f19350505050158015611609573d6000803e3d6000fd5b5060408051828152905133917f5d3b8fa9823b18b176cfe79e002a5b931b8569313802f700eb8550bc6a353246919081900360200190a250565b60076020526000908152604090208054600182015460028301546003909301549192909184565b600054630100000090046001600160a01b031633146116c9576040805162461bcd60e51b815260206004820152601660248201527513db9b1e481d985b1a59185d1bdc88185b1b1bddd95960521b604482015290519081900360640190fd5b600180546001600160a01b0319166001600160a01b0383169081179091556040517f5cd5185727f6057b7a274979ce4d902e15bf0ef1dc542d1fe5926cba874f63b690600090a250565b6001546001600160a01b03163314611769576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b60005460045461010090910460ff1690600182600181111561178757fe5b14156117e75760008111801561179f57506103e88111155b6117e2576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b61184b565b6000811180156118085750611804600a6108646103e86003611f96565b8111155b61184b576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b6005541580159061186a5750600554606490611868904390612038565b115b6118b6576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b600480546003819055600091829055600582905560405190917f450a792501c47863e89114cbdd0497acb22d4abfc51dc315afc323c5ba92d4a991a25050565b60005462010000900460ff1681565b601581565b61f0056001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561194757600080fd5b505af115801561195b573d6000803e3d6000fd5b5050336000908152600760205260408120600181015490546008549294506119979350909161086a91670de0b6b3a76400009161086491611f96565b90503415611ab957336000908152600760205260409020546119b9903461207a565b3360009081526007602052604090208190556008546119e691670de0b6b3a7640000916108649190611f96565b33600090815260076020526040902060010155600954611a06903461207a565b60095560408051348152905133917fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c919081900360200190a2600160005462010000900460ff166003811115611a5857fe5b1415611ab45761f0056001600160a01b031663136ec0b36040518163ffffffff1660e01b8152600401600060405180830381600087803b158015611a9b57600080fd5b505af1158015611aaf573d6000803e3d6000fd5b505050505b611af7565b60085433600090815260076020526040902054611ae391670de0b6b3a76400009161086491611f96565b336000908152600760205260409020600101555b8015610d1f57604051339082156108fc029083906000818181858888f19350505050158015611b2a573d6000803e3d6000fd5b5060408051828152905133917f7cddc560d4de1ea9d83e4123f01e6072afc503bb47bcc765f0396ba3861a0454919081900360200190a250565b6001546001600160a01b03163314611bba576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b600160005462010000900460ff166003811115611bd357fe5b14611c17576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b43600b556000805462ff000019169081905562010000900460ff166003811115611c3d57fe5b6040516000805160206121d183398151915290600090a261f0056001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b158015611c9157600080fd5b505af1158015611ca5573d6000803e3d6000fd5b50506000805460405163010000009091046001600160a01b031693507f7c79e6e24ed041d1072d54523b53956f01b91b835f0490856370594d9d14470e9250a2565b6001546001600160a01b03163314611d3d576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b600054610100900460ff16816001826001811115611d5757fe5b1415611db757600081118015611d6f57506103e88111155b611db2576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b611e1b565b600081118015611dd85750611dd4600a6108646103e86003611f96565b8111155b611e1b576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b60048390554360055560405183907f2dcbffddb492dea86de0b18dac6d71f51a7b7a5ec946512e0c993a050f3b48ea90600090a2505050565b60095481565b60065481565b3361f00514611eb1576040805162461bcd60e51b815260206004820152601860248201527756616c696461746f727320636f6e7472616374206f6e6c7960401b604482015290519081900360640190fd5b6000611ece6103e861086460035434611f9690919063ffffffff16565b600654909150611ede908261207a565b60065560095415611f2457611f20600854611f1a600954610864670de0b6b3a7640000611f14873461203890919063ffffffff16565b90611f96565b9061207a565b6008555b47611f48670de0b6b3a7640000610864600954600854611f9690919063ffffffff16565b600654011115610d1f576040805162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b604482015290519081900360640190fd5b600082611fa557506000610d61565b82820282848281611fb257fe5b0414611fef5760405162461bcd60e51b81526004018080602001828103825260218152602001806121f16021913960400191505060405180910390fd5b9392505050565b6000611fef83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f0000000000008152506120d4565b6000611fef83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250612176565b600082820183811015611fef576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b600081836121605760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561212557818101518382015260200161210d565b50505050905090810190601f1680156121525780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b50600083858161216c57fe5b0495945050505050565b600081848411156121c85760405162461bcd60e51b815260206004820181815283516024840152835190928392604490910191908501908083836000831561212557818101518382015260200161210d565b50505090039056fe402ee26d4c255fcb07b0b7b5b93b77377832260977c25be44f3c8feffd2df70e536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a264697066735822122041322335a3bfb055a8d351679c467b90e46a92c18f756d6bfe99651524f7d91c64736f6c634300060c0033536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77436f72726573706f6e64696e6720766f746520706f6f6c206e6f7420666f756e64a264697066735822122037fea8d962253dcfaa40ddeba2b38ffcf6646ba2e206543c110216f565188ec864736f6c634300060c0033"
)

type hardForkValidatorsV1 struct {
}

func (s *hardForkValidatorsV1) GetName() string {
	return ValidatorsV1ContractName
}

func (s *hardForkValidatorsV1) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV1Code)

	//write code to sys contract
	state.SetCode(ValidatorsV1ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV1ContractAddr.String(), "code", validatorV1Code)

	return
}

func (s *hardForkValidatorsV1) getAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return validatorV1Admin
	}

	return validatorV1AdminTestnet
}

func (s *hardForkValidatorsV1) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}
	managers := make([]common.Address, 0, len(topVals))
	for _, val := range topVals {
		feeAddr, err := v0.GetValidatorFeeAddr(val, state, header, chainContext, config)
		if err != nil {
			return err
		}
		managers = append(managers, feeAddr)
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV1ContractName].Pack(method, topVals, managers, s.getAdminByChainId(config.ChainID))
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := types.NewMessage(header.Coinbase, &ValidatorsV1ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
