package systemcontract

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
	"math"
	"math/big"
)

var (
	//TODO: set these to formal addresses
	validatorV1Admin        = common.HexToAddress("0x8Cc5A1a0802DB41DB826C2FcB72423744338DcB0")
	validatorV1AdminTestnet = common.HexToAddress("0x8Cc5A1a0802DB41DB826C2FcB72423744338DcB0")
)

const (
	validatorV1Code = "0x6080604052600436106200021e5760003560e01c8063741579b11162000127578063bb8b65af11620000af578063f04a5dcd1162000079578063f04a5dcd14620008f0578063f0fdb0291462000921578063f40f0f521462000939578063f5323feb1462000970578063f851a4401462000988576200021e565b8063bb8b65af1462000887578063c885bc58146200089f578063c967f90f14620008b7578063d6c0edad14620008e6576200021e565b80638fffcbd011620000f15780638fffcbd0146200078e5780639001eed814620007d7578063afeea11514620007ef578063b53ee1201462000859576200021e565b8063741579b114620002235780638ab66a9014620006ce5780638f28397014620007055780638f44c929146200073c576200021e565b80633a82fd5e11620001ab5780635594053d11620001755780635594053d14620005875780635dd0959014620005c65780636846992a14620005fd57806371df767814620006b6576200021e565b80633a82fd5e146200035a5780633b58524d14620003a157806344842f4614620003e05780635274ac3f146200043e576200021e565b806315de360e11620001ed57806315de360e14620002dd578063303a4a4614620002f557806331147c30146200032a5780633a5381b51462000342576200021e565b806303fab4f61462000223578063136ec0b3146200024d57806314f64c781462000267578063158ef93e14620002b1575b600080fd5b3480156200023057600080fd5b506200023b620009a0565b60408051918252519081900360200190f35b3480156200025a57600080fd5b5062000265620009ac565b005b3480156200027457600080fd5b5062000295600480360360208110156200028d57600080fd5b503562000bf7565b604080516001600160a01b039092168252519081900360200190f35b348015620002be57600080fd5b50620002c962000c1f565b604080519115158252519081900360200190f35b348015620002ea57600080fd5b506200023b62000c28565b3480156200030257600080fd5b506200030d62000c28565b6040805167ffffffffffffffff9092168252519081900360200190f35b3480156200033757600080fd5b506200023b62000c2d565b3480156200034f57600080fd5b506200029562000c33565b3480156200036757600080fd5b506200038b600480360360208110156200038057600080fd5b503560ff1662000c47565b6040805160ff9092168252519081900360200190f35b348015620003ae57600080fd5b506200026560048036036040811015620003c757600080fd5b506001600160a01b038135811691602001351662000c5c565b348015620003ed57600080fd5b5062000411600480360360208110156200040657600080fd5b503560ff1662000c94565b604080516001600160a01b03948516815292909316602083015260ff168183015290519081900360600190f35b3480156200044b57600080fd5b5062000265600480360360608110156200046457600080fd5b8101906020810181356401000000008111156200048057600080fd5b8201836020820111156200049357600080fd5b80359060200191846020830284011164010000000083111715620004b657600080fd5b91908080602002602001604051908101604052809392919081815260200183836020028082843760009201919091525092959493602081019350359150506401000000008111156200050757600080fd5b8201836020820111156200051a57600080fd5b803590602001918460208302840111640100000000831117156200053d57600080fd5b919080806020026020016040519081016040528093929190818152602001838360200280828437600092019190915250929550505090356001600160a01b0316915062000cc69050565b3480156200059457600080fd5b506200026560048036036040811015620005ad57600080fd5b506001600160a01b038135169060200135151562001056565b348015620005d357600080fd5b506200026560048036036020811015620005ec57600080fd5b50356001600160a01b031662001171565b3480156200060a57600080fd5b5062000265600480360360408110156200062357600080fd5b8101906020810181356401000000008111156200063f57600080fd5b8201836020820111156200065257600080fd5b803590602001918460208302840111640100000000831117156200067557600080fd5b91908080602002602001604051908101604052809392919081815260200183836020028082843760009201919091525092955050913592506200119d915050565b348015620006c357600080fd5b506200026562001563565b348015620006db57600080fd5b506200029560048036036020811015620006f457600080fd5b50356001600160a01b0316620016f2565b3480156200071257600080fd5b5062000265600480360360208110156200072b57600080fd5b50356001600160a01b03166200170d565b3480156200074957600080fd5b5062000295600480360360808110156200076257600080fd5b506001600160a01b03813581169160208101359091169060ff60408201358116916060013516620017aa565b3480156200079b57600080fd5b506200026560048036036080811015620007b457600080fd5b5060ff81358116916020810135821691604082013581169160600135166200195a565b348015620007e457600080fd5b506200023b62001b6d565b348015620007fc57600080fd5b506200080762001b79565b60408051602080825283518183015283519192839290830191858101910280838360005b83811015620008455781810151838201526020016200082b565b505050509050019250505060405180910390f35b3480156200086657600080fd5b5062000295600480360360208110156200087f57600080fd5b503562001e7c565b3480156200089457600080fd5b506200026562001e8a565b348015620008ac57600080fd5b5062000265620020d0565b348015620008c457600080fd5b50620008cf62002135565b6040805161ffff9092168252519081900360200190f35b620002656200213a565b348015620008fd57600080fd5b506200038b600480360360208110156200091657600080fd5b503560ff1662002535565b3480156200092e57600080fd5b506200023b6200254a565b3480156200094657600080fd5b506200023b600480360360208110156200095f57600080fd5b50356001600160a01b031662002550565b3480156200097d57600080fd5b506200029562002562565b3480156200099557600080fd5b506200029562002571565b670de0b6b3a764000081565b6000339050806001600160a01b031660086000836001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b158015620009f957600080fd5b505afa15801562000a0e573d6000803e3d6000fd5b505050506040513d602081101562000a2557600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462000a92576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b336001816001600160a01b031663c19d93fb6040518163ffffffff1660e01b815260040160206040518083038186803b15801562000acf57600080fd5b505afa15801562000ae4573d6000803e3d6000fd5b505050506040513d602081101562000afb57600080fd5b5051600381111562000b0957fe5b1462000b4e576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6000600a6000836001600160a01b031663bd0463546040518163ffffffff1660e01b815260040160206040518083038186803b15801562000b8e57600080fd5b505afa15801562000ba3573d6000803e3d6000fd5b505050506040513d602081101562000bba57600080fd5b5051600181111562000bc857fe5b600181111562000bd457fe5b81526020810191909152604001600020905062000bf2813362002580565b505050565b6005818154811062000c0557fe5b6000918252602090912001546001600160a01b0316905081565b60005460ff1681565b600081565b60055490565b60005461010090046001600160a01b031681565b60036020526000908152604090205460ff1681565b60008054610100600160a81b0319166101006001600160a01b0394851602179055600180546001600160a01b03191691909216179055565b600a60205260009081526040902080546001909101546001600160a01b0391821691811690600160a01b900460ff1683565b6000835111801562000cd9575081518351145b62000d1c576040805162461bcd60e51b815260206004820152600e60248201526d496e76616c696420706172616d7360901b604482015290519081900360640190fd5b6001600160a01b03811662000d70576040805162461bcd60e51b8152602060048201526015602482015274496e76616c69642061646d696e206164647265737360581b604482015290519081900360640190fd5b60008054600160ff1991821681178355600280546001600160a01b0319166001600160a01b0386161790557f3617319a054d772f909f7c479a2cebe5066e836a939412e32403c99029b92eff80548316905582527fa15bc60c955c405d20d9149c709e2460f1c2d9a497496a7f46004d1772c3054c8054601590831617905560046020527f17ef568e3e12ab5b9c7254a8d58478811de00f9e6eb34345acd53bf8fd09d3ec8054821690557fabd6e7cb50984ff9c2f3e18a2660c3353dadf4e3291deeb275dae2cd1e44fe05805490911690555b83518160ff16101562001050576000848260ff168151811062000e6357fe5b6020908102919091018101516001600160a01b0380821660009081526008909352604090922054909250161562000edc576040805162461bcd60e51b815260206004820152601860248201527743616e64696461746520616c72656164792065786973747360401b604482015290519081900360640190fd5b60008182606460018060405162000ef39062003357565b80866001600160a01b03168152602001856001600160a01b0316815260200184815260200183600181111562000f2557fe5b815260200182600381111562000f3757fe5b815260200195505050505050604051809103906000f08015801562000f60573d6000803e3d6000fd5b506001600160a01b0383811660009081526008602052604080822080546001600160a01b03191693851693841790558051633b58524d60e01b81523060048201526024810183905290519394509192633b58524d92604480820193929182900301818387803b15801562000fd357600080fd5b505af115801562000fe8573d6000803e3d6000fd5b50505050806001600160a01b0316638129fc1c6040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156200102857600080fd5b505af11580156200103d573d6000803e3d6000fd5b50506001909401935062000e4492505050565b50505050565b6002546001600160a01b03163314620010a3576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b6001600160a01b0382811660009081526008602052604090205416620010fb5760405162461bcd60e51b81526004018080602001828103825260218152602001806200531d6021913960400191505060405180910390fd5b6001600160a01b03808316600090815260086020526040808220548151638ec7a23d60e01b815285151560048201529151931692638ec7a23d9260248084019391929182900301818387803b1580156200115457600080fd5b505af115801562001169573d6000803e3d6000fd5b505050505050565b6001600160a01b0390811660009081526008602090815260408083205490931682526009905290812055565b436000908152600b60209081526040808320600180855292529091205460ff161562001203576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481bdc195c985d195960821b604482015290519081900360640190fd5b436000908152600b60209081526040808320600180855292528220805460ff1916909117905582905b60055460ff82161015620012915760006007600060058460ff16815481106200125157fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805460ff191660ff929092169190911790556001016200122c565b508351620012a790600590602087019062003365565b5060005b60055460ff82161015620013105760016007600060058460ff1681548110620012d057fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805460ff191660ff92909216919091179055600101620012ab565b506200131f60066000620033cf565b62001329620033f2565b50604080518082019091526000808252600160208301525b60028160ff1610156200116957600060046000848460ff16600281106200136457fe5b602002015160018111156200137557fe5b60018111156200138157fe5b815260200190815260200160002060009054906101000a900460ff1690506000600a6000858560ff1660028110620013b557fe5b60200201516001811115620013c657fe5b6001811115620013d257fe5b8152602081019190915260400160002080549091506001600160a01b03165b6001600160a01b03811615620015575760076000826001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b1580156200143f57600080fd5b505afa15801562001454573d6000803e3d6000fd5b505050506040513d60208110156200146b57600080fd5b50516001600160a01b0316815260208101919091526040016000205460ff1662001534576006816001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b158015620014cb57600080fd5b505afa158015620014e0573d6000803e3d6000fd5b505050506040513d6020811015620014f757600080fd5b505181546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b0390921691909117905560001992909201915b6001600160a01b03908116600090815260038301602052604090205416620013f1565b50505060010162001341565b6000339050806001600160a01b031660086000836001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b158015620015b057600080fd5b505afa158015620015c5573d6000803e3d6000fd5b505050506040513d6020811015620015dc57600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462001649576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b60003390506000600a6000836001600160a01b031663bd0463546040518163ffffffff1660e01b815260040160206040518083038186803b1580156200168e57600080fd5b505afa158015620016a3573d6000803e3d6000fd5b505050506040513d6020811015620016ba57600080fd5b50516001811115620016c857fe5b6001811115620016d457fe5b81526020810191909152604001600020905062000bf2818362002b40565b6008602052600090815260409020546001600160a01b031681565b6002546001600160a01b031633146200175a576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b600280546001600160a01b0319166001600160a01b0383811691909117918290556040519116907f927cc064d7b7fa546fa7706bc01845d27d06f15af3ae90a672cc44735928e96190600090a250565b6002546000906001600160a01b03163314620017fa576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b6001600160a01b03858116600090815260086020526040902054161562001863576040805162461bcd60e51b815260206004820152601860248201527743616e64696461746520616c72656164792065786973747360401b604482015290519081900360640190fd5b6000858585856000604051620018799062003357565b80866001600160a01b03168152602001856001600160a01b031681526020018460ff168152602001836001811115620018ae57fe5b8152602001826003811115620018c057fe5b815260200195505050505050604051809103906000f080158015620018e9573d6000803e3d6000fd5b506001600160a01b0387811660008181526008602090815260409182902080546001600160a01b03191694861694851790558151938452905193945090927faa09247a2eedc4269bc491bbe4eb4f35da3a820e053f362953f56884adecab199281900390910190a295945050505050565b6002546001600160a01b03163314620019a7576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60ff84830116601514620019f3576040805162461bcd60e51b815260206004820152600e60248201526d496e76616c696420706172616d7360901b604482015290519081900360640190fd5b8360ff168360ff161115801562001a1057508160ff168160ff1611155b62001a5a576040805162461bcd60e51b8152602060048201526015602482015274496e76616c6964206261636b757020636f756e747360581b604482015290519081900360640190fd5b7f3617319a054d772f909f7c479a2cebe5066e836a939412e32403c99029b92eff805460ff86811660ff1992831681179093557fa15bc60c955c405d20d9149c709e2460f1c2d9a497496a7f46004d1772c3054c80548683169084168117909155600460209081527f17ef568e3e12ab5b9c7254a8d58478811de00f9e6eb34345acd53bf8fd09d3ec8054851689851690811790915560016000527fabd6e7cb50984ff9c2f3e18a2660c3353dadf4e3291deeb275dae2cd1e44fe0580549095169387169384179094556040805195865290850193909352838301526060830152517fef8fc40942f0314a9f5ebd7832ff1b78e6c4b5b7062355066b0c0e3e0edc6f29916080908290030190a150505050565b674563918244f4000081565b6060600062001b87620033f2565b50604080518082019091526000808252600160208301525b60028160ff16101562001c9a576000828260ff166002811062001bbe57fe5b602002015190506000600a600083600181111562001bd857fe5b600181111562001be457fe5b815260200190815260200160002090506003600083600181111562001c0557fe5b600181111562001c1157fe5b8152602081019190915260400160002054600182015460ff918216600160a01b909104909116101562001c58576001810154600160a01b900460ff16949094019362001c8f565b6003600083600181111562001c6957fe5b600181111562001c7557fe5b815260208101919091526040016000205460ff1694909401935b505060010162001b9f565b5060608260ff1667ffffffffffffffff8111801562001cb857600080fd5b5060405190808252806020026020018201604052801562001ce3578160200160208202803683370190505b5090506000805b60028160ff16101562001e72576000848260ff166002811062001d0957fe5b602002015190506000600a600083600181111562001d2357fe5b600181111562001d2f57fe5b8152602001908152602001600020905060006003600084600181111562001d5257fe5b600181111562001d5e57fe5b8152602081019190915260400160002054825460ff90911691506001600160a01b03165b60008260ff1611801562001d9e57506001600160a01b03811615155b1562001e6157806001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b15801562001dde57600080fd5b505afa15801562001df3573d6000803e3d6000fd5b505050506040513d602081101562001e0a57600080fd5b50518751889060ff891690811062001e1e57fe5b6001600160a01b03928316602091820292909201810191909152918116600090815260038501909252604090912054600190960195600019909201911662001d82565b50506001909201915062001cea9050565b5090935050505090565b6006818154811062000c0557fe5b6000339050806001600160a01b031660086000836001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b15801562001ed757600080fd5b505afa15801562001eec573d6000803e3d6000fd5b505050506040513d602081101562001f0357600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462001f70576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b336001816001600160a01b031663c19d93fb6040518163ffffffff1660e01b815260040160206040518083038186803b15801562001fad57600080fd5b505afa15801562001fc2573d6000803e3d6000fd5b505050506040513d602081101562001fd957600080fd5b5051600381111562001fe757fe5b146200202c576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6000600a6000836001600160a01b031663bd0463546040518163ffffffff1660e01b815260040160206040518083038186803b1580156200206c57600080fd5b505afa15801562002081573d6000803e3d6000fd5b505050506040513d60208110156200209857600080fd5b50516001811115620020a657fe5b6001811115620020b257fe5b81526020810191909152604001600020905062000bf2818362002d35565b3360009081526009602052604090205480620020ed575062002133565b3360008181526009602052604080822082905580516379b6053960e11b8152905163f36c0a729285926004808201939182900301818588803b1580156200115457600080fd5b565b601581565b436000908152600b6020908152604080832083805290915281205460ff16156200219e576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481bdc195c985d195960821b604482015290519081900360640190fd5b436000908152600b602090815260408083208380529091529020805460ff19166001179055600654349015620022a557600654600090620021f090620021e960648134601462003109565b9062003170565b905060005b60065460ff82161015620022835760006008600060068460ff16815481106200221a57fe5b60009182526020808320909101546001600160a01b03908116845283820194909452604092830182205490931680825260099093522054909150620022609084620031b4565b6001600160a01b03909116600090815260096020526040902055600101620021f5565b50600654620022a1906200229990839062003109565b83906200320f565b9150505b6005541562002531576000805b60055460ff8216101562002379576200236e6008600060058460ff1681548110620022d957fe5b60009182526020808320909101546001600160a01b03908116845283820194909452604092830190912054825163f1cea4c760e01b8152925193169263f1cea4c7926004808201939291829003018186803b1580156200233857600080fd5b505afa1580156200234d573d6000803e3d6000fd5b505050506040513d60208110156200236457600080fd5b50518390620031b4565b9150600101620022b2565b5060008082116200238c5760006200239f565b6200239f6064620021e934602862003109565b600554909150600090620023b990620021e986856200320f565b905060005b60055460ff82161015620011695760006008600060058460ff1681548110620023e357fe5b60009182526020808320909101546001600160a01b0390811684529083019390935260409091019020541690508415620024e85760006200249286620021e987856001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b1580156200245d57600080fd5b505afa15801562002472573d6000803e3d6000fd5b505050506040513d60208110156200248957600080fd5b50519062003109565b6001600160a01b038316600090815260096020526040902054909150620024c8908590620024c19084620031b4565b90620031b4565b6001600160a01b0383166000908152600960205260409020555062002527565b6001600160a01b0381166000908152600960205260409020546200250d9084620031b4565b6001600160a01b0382166000908152600960205260409020555b50600101620023be565b5050565b60046020526000908152604090205460ff1681565b60065490565b60096020526000908152604090205481565b6001546001600160a01b031681565b6002546001600160a01b031681565b6001820154600160a01b900460ff16620025e55781546001600160a01b0382166001600160a01b0319918216811784556001808501805460ff600160a01b91909516909317838104851690920190931690910260ff60a01b1990911617905562002531565b81546001600160a01b0382811691161415620026015762002531565b6001600160a01b0380821660009081526002840160205260409020541680620027aa576001808401805460ff600160a01b80830482169094011690920260ff60a01b1990921691909117908190556040805163f1cea4c760e01b815290516001600160a01b039092169163f1cea4c791600480820192602092909190829003018186803b1580156200269257600080fd5b505afa158015620026a7573d6000803e3d6000fd5b505050506040513d6020811015620026be57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b1580156200270157600080fd5b505afa15801562002716573d6000803e3d6000fd5b505050506040513d60208110156200272d57600080fd5b5051116200279557506001820180546001600160a01b038381166000818152600287016020908152604080832080549686166001600160a01b031997881617905586549094168252600388019052919091208054831682179055825490911617905562002531565b5060018201546001600160a01b031662002941565b806001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b158015620027e457600080fd5b505afa158015620027f9573d6000803e3d6000fd5b505050506040513d60208110156200281057600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b1580156200285357600080fd5b505afa15801562002868573d6000803e3d6000fd5b505050506040513d60208110156200287f57600080fd5b5051116200288e575062002531565b6001600160a01b038083166000818152600386016020526040808220548585168352912080546001600160a01b03191691841691909117905560018501549091161415620028f9576001830180546001600160a01b0319166001600160a01b03831617905562002941565b6001600160a01b03808316600090815260028501602081815260408084205460038901835281852054861685529290915290912080546001600160a01b031916919092161790555b6001600160a01b0381161580159062002a2e5750806001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b1580156200298f57600080fd5b505afa158015620029a4573d6000803e3d6000fd5b505050506040513d6020811015620029bb57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b158015620029fe57600080fd5b505afa15801562002a13573d6000803e3d6000fd5b505050506040513d602081101562002a2a57600080fd5b5051115b1562002a57576001600160a01b0390811660009081526002840160205260409020541662002941565b6001600160a01b03811662002ace575081546001600160a01b038281166000818152600386016020908152604080832080549686166001600160a01b031997881617905587549094168252600287019052828120805485168317905581815291909120805483169055835490911617825562002531565b6001600160a01b0390811660008181526003850160209081526040808320805496861680855282852080549888166001600160a01b0319998a16179055815490961684526002909701909152808220805486168517905585548516841790955591825292902080549091169091179055565b81546001600160a01b0382811691161480159062002b7857506001600160a01b03818116600090815260028401602052604090205416155b1562002b845762002531565b60018201546001600160a01b038281169116141562002bd1576001600160a01b0380821660009081526002840160205260409020546001840180546001600160a01b031916919092161790555b81546001600160a01b038281169116141562002c15576001600160a01b03808216600090815260038401602052604090205483546001600160a01b03191691161782555b6001600160a01b03808216600090815260038401602052604090205416801562002c71576001600160a01b038083166000908152600285016020526040808220548484168352912080546001600160a01b031916919092161790555b6001600160a01b03808316600090815260028501602052604090205416801562002ccd576001600160a01b038084166000908152600386016020526040808220548484168352912080546001600160a01b031916919092161790555b50506001600160a01b03166000908152600282016020908152604080832080546001600160a01b03199081169091556003850190925290912080549091169055600101805460ff60a01b198116600160a01b9182900460ff9081166000190116909102179055565b6001600160a01b03808216600081815260038501602052604090205460018501549083169216148062002d6f57506001600160a01b038116155b8062002e505750816001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b15801562002db057600080fd5b505afa15801562002dc5573d6000803e3d6000fd5b505050506040513d602081101562002ddc57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0384169163f1cea4c7916004808301926020929190829003018186803b15801562002e1f57600080fd5b505afa15801562002e34573d6000803e3d6000fd5b505050506040513d602081101562002e4b57600080fd5b505111155b1562002e5d575062002531565b6001600160a01b038083166000818152600286016020526040808220548585168352912080546001600160a01b0319169184169190911790558454909116141562002ec15782546001600160a01b0319166001600160a01b03821617835562002f03565b6001600160a01b0382811660009081526002850160209081526040808320548416835260038701909152902080546001600160a01b0319169183169190911790555b6001600160a01b0381161580159062002ff05750816001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b15801562002f5157600080fd5b505afa15801562002f66573d6000803e3d6000fd5b505050506040513d602081101562002f7d57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0384169163f1cea4c7916004808301926020929190829003018186803b15801562002fc057600080fd5b505afa15801562002fd5573d6000803e3d6000fd5b505050506040513d602081101562002fec57600080fd5b5051115b1562003019576001600160a01b0390811660009081526003840160205260409020541662002f03565b6001600160a01b03811662003091576001830180546001600160a01b038481166000818152600288016020908152604080832080549686166001600160a01b031997881617905560038a0190915280822080548616905585549093168152919091208054831682179055825490911617905562000bf2565b6001600160a01b0390811660008181526002850160208181526040808420805487168552600390980180835281852080546001600160a01b0319908116998916998a17909155848452895489875283872080549190991690821617909755825283208054861685179055929091529052825416179055565b6000826200311a575060006200316a565b828202828482816200312857fe5b0414620031675760405162461bcd60e51b81526004018080602001828103825260218152602001806200533e6021913960400191505060405180910390fd5b90505b92915050565b60006200316783836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525062003253565b60008282018381101562003167576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b60006200316783836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250620032fa565b60008183620032e35760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015620032a75781810151838201526020016200328d565b50505050905090810190601f168015620032d55780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b506000838581620032f057fe5b0495945050505050565b600081848411156200334f5760405162461bcd60e51b8152602060048201818152835160248401528351909283926044909101919085019080838360008315620032a75781810151838201526020016200328d565b505050900390565b611ed4806200344983390190565b828054828255906000526020600020908101928215620033bd579160200282015b82811115620033bd57825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062003386565b50620033cb92915062003410565b5090565b5080546000825590600052602060002090810190620033ef919062003431565b50565b60405180604001604052806002906020820280368337509192915050565b5b80821115620033cb5780546001600160a01b031916815560010162003411565b5b80821115620033cb57600081556001016200343256fe608060405234801561001057600080fd5b50604051611ed4380380611ed4833981810160405260a081101561003357600080fd5b5080516020820151604083015160608401516080909401519293919290919060ff8316801580159061006b57506103e88161ffff1611155b6100ae576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600280546001600160a01b038089166001600160a01b03199283161790925560038054928816929091169190911790556005805461ffff191660ff86161790556001805484919060ff60a01b1916600160a01b838381111561010c57fe5b02179055506001805483919060ff60a81b1916600160a81b83600381111561013057fe5b0217905550505050505050611d8a8061014a6000396000f3fe60806040526004361061021a5760003560e01c80638ec7a23d11610123578063bd046354116100ab578063d0e30db01161006f578063d0e30db014610625578063e9fad8ee1461062d578063f1cea4c714610642578063f36c0a7214610657578063f5323feb1461065f5761021a565b8063bd04635414610554578063be10c7f21461058a578063c19d93fb146105bd578063c967f90f146105e2578063ce42ae1b146105f75761021a565b80639e83d5b1116100f25780639e83d5b114610491578063a1109b43146104a6578063a3ec138d146104bb578063a3fbbaae1461050c578063a66066791461053f5761021a565b80638ec7a23d146104265780638f76691a146104525780639001eed814610467578063939d62371461047c5761021a565b8063481c6a75116101a65780636c8381f8116101755780636c8381f8146103bb57806370ba1113146103d0578063741579b11461021f5780638129fc1c146103fc578063826d3dec146104115761021a565b8063481c6a7514610356578063483a00e81461036b5780634d6ec486146103735780634df9d6ba146103885761021a565b8063303a4a46116101ed578063303a4a4614610299578063398b57ee146102cb5780633a5381b5146102d55780633b58524d146103065780633ccfd60b146103415761021a565b806303fab4f61461021f578063158ef93e1461024657806315de360e1461026f57806324c5b1ca14610284575b600080fd5b34801561022b57600080fd5b50610234610674565b60408051918252519081900360200190f35b34801561025257600080fd5b5061025b610680565b604080519115158252519081900360200190f35b34801561027b57600080fd5b50610234610689565b34801561029057600080fd5b5061023461068e565b3480156102a557600080fd5b506102ae610689565b6040805167ffffffffffffffff9092168252519081900360200190f35b6102d3610694565b005b3480156102e157600080fd5b506102ea61080c565b604080516001600160a01b039092168252519081900360200190f35b34801561031257600080fd5b506102d36004803603604081101561032957600080fd5b506001600160a01b0381358116916020013516610820565b34801561034d57600080fd5b506102d3610858565b34801561036257600080fd5b506102ea610a82565b6102d3610a91565b34801561037f57600080fd5b50610234610d11565b34801561039457600080fd5b50610234600480360360208110156103ab57600080fd5b50356001600160a01b0316610d17565b3480156103c757600080fd5b506102ea610d5c565b3480156103dc57600080fd5b506103e5610d6b565b6040805161ffff9092168252519081900360200190f35b34801561040857600080fd5b506102d3610d75565b34801561041d57600080fd5b506102d3610de0565b34801561043257600080fd5b506102d36004803603602081101561044957600080fd5b50351515610f81565b34801561045e57600080fd5b50610234611100565b34801561047357600080fd5b50610234611106565b34801561048857600080fd5b50610234611112565b34801561049d57600080fd5b506102d3611118565b3480156104b257600080fd5b50610234611286565b3480156104c757600080fd5b506104ee600480360360208110156104de57600080fd5b50356001600160a01b031661128c565b60408051938452602084019290925282820152519081900360600190f35b34801561051857600080fd5b506102d36004803603602081101561052f57600080fd5b50356001600160a01b03166112ad565b34801561054b57600080fd5b506102d361134f565b34801561056057600080fd5b506105696114b4565b6040518082600181111561057957fe5b815260200191505060405180910390f35b34801561059657600080fd5b5061059f6114c4565b6040805161ffff909316835260208301919091528051918290030190f35b3480156105c957600080fd5b506105d26114d4565b6040518082600381111561057957fe5b3480156105ee57600080fd5b506103e56114e4565b34801561060357600080fd5b506102d36004803603602081101561061a57600080fd5b503561ffff166114e9565b6102d36115e2565b34801561063957600080fd5b506102d3611869565b34801561064e57600080fd5b506102346119fd565b6102d3611a03565b34801561066b57600080fd5b506102ea611aca565b670de0b6b3a764000081565b60005460ff1681565b600081565b600b5481565b6003546001600160a01b031633146106ea576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b600060019054906101000a90046001600160a01b03166001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561073a57600080fd5b505af115801561074e573d6000803e3d6000fd5b5050505060006006541161079a576040805162461bcd60e51b815260206004820152600e60248201526d27379036b7b9329036b0b933b4b760911b604482015290519081900360640190fd5b600680546000918290556040519091339183156108fc0291849190818181858888f193505050501580156107d2573d6000803e3d6000fd5b5060408051828152905133917ffb921c09e6e10d5022fbe1d986d5f02280be4c56981c880923b285ea0d085381919081900360200190a250565b60005461010090046001600160a01b031681565b60008054610100600160a81b0319166101006001600160a01b0394851602179055600180546001600160a01b03191691909216179055565b336000526007602052600060019054906101000a90046001600160a01b03166001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156108b157600080fd5b505af11580156108c5573d6000803e3d6000fd5b50503360009081526007602052604081206001810154905460085492945061090d9350909161090791670de0b6b3a76400009161090191611ad9565b90611b39565b90611b7b565b3360009081526007602052604090205460095491925061092d9190611b7b565b6009553360009081526007602052604081208054828255600191820192909255600154600160a81b900460ff16600381111561096557fe5b14156109d457600060019054906101000a90046001600160a01b03166001600160a01b031663bb8b65af6040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156109bb57600080fd5b505af11580156109cf573d6000803e3d6000fd5b505050505b8015610a7e57336108fc6109e88385611bbd565b6040518115909202916000818181858888f19350505050158015610a10573d6000803e3d6000fd5b5060408051828152905133917f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364919081900360200190a260408051838152905133917f7cddc560d4de1ea9d83e4123f01e6072afc503bb47bcc765f0396ba3861a0454919081900360200190a25b5050565b6003546001600160a01b031681565b6003546001600160a01b03163314610ae7576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b6000600154600160a81b900460ff166003811115610b0157fe5b1480610b3357506003600154600160a81b900460ff166003811115610b2257fe5b148015610b3357506000600a544303115b610b76576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600b541580610b83575060015b610bcf576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b6004805434908101909155604080519182525133917f278e696bd0cd4a7d1260ced26c40cd01c2b088f441889e4148240ac81069b348919081900360200190a260006001808054600160a01b900460ff1690811115610c2a57fe5b1415610c3f5750670de0b6b3a7640000610c4a565b50674563918244f400005b8060045410610d0e576001805460ff60a81b1916600160a81b1790819055600254604080516363e1d45160e01b81526001600160a01b039283166004820152905191909216916363e1d45191602480830192600092919082900301818387803b158015610cb657600080fd5b505af1158015610cca573d6000803e3d6000fd5b50505050600080516020611d14833981519152600160159054906101000a900460ff1660405180826003811115610cfd57fe5b815260200191505060405180910390a15b50565b60065481565b6001600160a01b038116600090815260076020526040812060018101549054600854610d56929161090791670de0b6b3a7640000916109019190611ad9565b92915050565b6002546001600160a01b031681565b60055461ffff1681565b60008054600160ff19909116178082556040805163136ec0b360e01b815290516101009092046001600160a01b03169263136ec0b39260048084019382900301818387803b158015610dc657600080fd5b505af1158015610dda573d6000803e3d6000fd5b50505050565b670de0b6b3a76400006004541015610e37576040805162461bcd60e51b8152602060048201526015602482015274139bc8195b9bdd59da081b585c99da5b881b19599d605a1b604482015290519081900360640190fd5b43600a556001805460ff60a81b1916600360a81b1790819055604051600080516020611d1483398151915291600160a81b900460ff169080826003811115610e7b57fe5b815260200191505060405180910390a1600060019054906101000a90046001600160a01b03166001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610edb57600080fd5b505af1158015610eef573d6000803e3d6000fd5b505060048054670de0b6b3a763ffff1901905550506040516000908190670de0b6b3a76400009082818181858280f19350505050158015610f34573d6000803e3d6000fd5b5060025460408051670de0b6b3a7640000815290516001600160a01b03909216917febbcaaf6b9aa8b4083ae4b2f842c8de6f75319018e7b5e141a1e87aebadde6c39181900360200190a2565b808015610fc557506000600154600160a81b900460ff166003811115610fa357fe5b1480610fc5575060018054600160a81b900460ff166003811115610fc357fe5b145b15611087576001805460ff60a81b1916600160a91b1790819055604051600080516020611d1483398151915291600160a81b900460ff16908082600381111561100a57fe5b815260200191505060405180910390a1600060019054906101000a90046001600160a01b03166001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561106a57600080fd5b505af115801561107e573d6000803e3d6000fd5b50505050610d0e565b801580156110ac57506002600154600160a81b900460ff1660038111156110aa57fe5b145b15610d0e576001805460ff60a81b191690819055604051600080516020611d1483398151915291600160a81b900460ff1690808260038111156110eb57fe5b815260200191505060405180910390a1610d0e565b60045481565b674563918244f4000081565b60085481565b6003546001600160a01b0316331461116e576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b6000600154600160a81b900460ff16600381111561118857fe5b146111cc576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600060045411611214576040805162461bcd60e51b815260206004820152600e60248201526d27379036b7b9329036b0b933b4b760911b604482015290519081900360640190fd5b600480546000918290556040519091339183156108fc0291849190818181858888f1935050505015801561124c573d6000803e3d6000fd5b5060408051828152905133917f5d3b8fa9823b18b176cfe79e002a5b931b8569313802f700eb8550bc6a353246919081900360200190a250565b600a5481565b60076020526000908152604090208054600182015460029092015490919083565b6002546001600160a01b03163314611305576040805162461bcd60e51b815260206004820152601660248201527513db9b1e4818d85b991a59185d1948185b1b1bddd95960521b604482015290519081900360640190fd5b600380546001600160a01b0319166001600160a01b0383169081179091556040517f5cd5185727f6057b7a274979ce4d902e15bf0ef1dc542d1fe5926cba874f63b690600090a250565b6003546001600160a01b031633146113a5576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b600c5461ffff1680158015906113c157506103e88161ffff1611155b611404576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600d5415801590611413575060015b61145f576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b600c80546005805461ffff80841661ffff19928316179283905592169092556000600d81905560405192909116917fcac49e9849a8f10ab0094584f2be1e8fdeb0fc92f3867604d41aaf917b5cc4599190a250565b600154600160a01b900460ff1681565b600c54600d5461ffff9091169082565b600154600160a81b900460ff1681565b601581565b6003546001600160a01b0316331461153f576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b8060008161ffff1611801561155a57506103e88161ffff1611155b61159d576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600c805461ffff191661ffff841690811790915543600d556040517f6f8588849b25baa50ffb5a79a8457f6111569a911a0cf6aca2bdc521365ab3ef90600090a25050565b600060019054906101000a90046001600160a01b03166001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561163257600080fd5b505af1158015611646573d6000803e3d6000fd5b5050336000908152600760205260408120600181015490546008549294506116829350909161090791670de0b6b3a76400009161090191611ad9565b905034156117be57336000908152600760205260409020546116a49034611bbd565b336000908152600760205260409020818155436002909101556008546116d891670de0b6b3a7640000916109019190611ad9565b336000908152600760205260409020600101556009546116f89034611bbd565b60095560018054600160a81b900460ff16600381111561171457fe5b141561178357600060019054906101000a90046001600160a01b03166001600160a01b031663136ec0b36040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561176a57600080fd5b505af115801561177e573d6000803e3d6000fd5b505050505b60408051348152905133917fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c919081900360200190a26117fc565b600854336000908152600760205260409020546117e891670de0b6b3a76400009161090191611ad9565b336000908152600760205260409020600101555b8015610d0e57604051339082156108fc029083906000818181858888f1935050505015801561182f573d6000803e3d6000fd5b5060408051828152905133917f7cddc560d4de1ea9d83e4123f01e6072afc503bb47bcc765f0396ba3861a0454919081900360200190a250565b6003546001600160a01b031633146118bf576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b60018054600160a81b900460ff1660038111156118d857fe5b1461191c576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b43600b556001805460ff60a81b191690819055604051600080516020611d1483398151915291600160a81b900460ff16908082600381111561195a57fe5b815260200191505060405180910390a1600060019054906101000a90046001600160a01b03166001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156119ba57600080fd5b505af11580156119ce573d6000803e3d6000fd5b50506040517f04311d55cecee233de1d4a7873cccf1ee3ba3128bddaea86d4f03c2dd359f0c1925060009150a1565b60095481565b600554600090611a20906103e89061090190349061ffff16611ad9565b6006805482019055600854600954919250611a5b91611a5590610901670de0b6b3a7640000611a4f3488611b7b565b90611ad9565b90611bbd565b60088190556009544791611a7c91670de0b6b3a76400009161090191611ad9565b600654011115610d0e576040805162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b604482015290519081900360640190fd5b6001546001600160a01b031681565b600082611ae857506000610d56565b82820282848281611af557fe5b0414611b325760405162461bcd60e51b8152600401808060200182810382526021815260200180611d346021913960400191505060405180910390fd5b9392505050565b6000611b3283836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250611c17565b6000611b3283836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250611cb9565b600082820183811015611b32576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b60008183611ca35760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015611c68578181015183820152602001611c50565b50505050905090810190601f168015611c955780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b506000838581611caf57fe5b0495945050505050565b60008184841115611d0b5760405162461bcd60e51b8152602060048201818152835160248401528351909283926044909101919085019080838360008315611c68578181015183820152602001611c50565b50505090039056fe402ee26d4c255fcb07b0b7b5b93b77377832260977c25be44f3c8feffd2df70e536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a26469706673582212208a21ff6ebd591bbb204a06abee3cc49bbfe8c61f1443c3e3b33923810d74590c64736f6c634300060c0033436f72726573706f6e64696e672063616e646964617465206e6f7420666f756e64536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a264697066735822122022e741a876862be78ae5a079745dfea18e4093c3e2b33f6ff06c5f2fd213e03664736f6c634300060c0033"
)

type hardForkValidatorsV1 struct {
}

func (s *hardForkValidatorsV1) GetName() string {
	return ValidatorsV1ContractName
}

func (s *hardForkValidatorsV1) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV1Code)

	//write code to sys contract
	state.SetCode(ValidatorsV1ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV1ContractAddr.String(), "code", validatorV1Code)

	return
}

func (s *hardForkValidatorsV1) getAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return validatorV1Admin
	}

	return validatorV1AdminTestnet
}

func (s *hardForkValidatorsV1) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}
	managers := make([]common.Address, 0, len(topVals))
	for _, val := range topVals {
		feeAddr, err := v0.GetValidatorFeeAddr(val, state, header, chainContext, config)
		if err != nil {
			return err
		}
		managers = append(managers, feeAddr)
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV1ContractName].Pack(method, topVals, managers, s.getAdminByChainId(config.ChainID))
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := types.NewMessage(header.Coinbase, &ValidatorsV1ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
