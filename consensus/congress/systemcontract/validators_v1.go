package systemcontract

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
	"math"
	"math/big"
)

var (
	//TODO: set these to formal addresses
	validatorV1Admin        = common.HexToAddress("0x000000000000000000000000000000000000FF00")
	validatorV1AdminTestnet = common.HexToAddress("0x000000000000000000000000000000000000FF00")
)

const (
	validatorV1Code = "0x608060405260043610620001fa5760003560e01c80638ab66a90116200010f578063bb8b65af11620000a3578063f04a5dcd116200006d578063f04a5dcd146200087d578063f40f0f5214620008ae578063f5323feb14620008e5578063f851a44014620008fd57620001fa565b8063bb8b65af1462000814578063c885bc58146200082c578063c967f90f1462000844578063d6c0edad146200087357620001fa565b80638fffcbd011620000e55780638fffcbd0146200071b5780639001eed81462000764578063afeea115146200077c578063b53ee12014620007e657620001fa565b80638ab66a90146200065b5780638f28397014620006925780638f44c92914620006c957620001fa565b80633a82fd5e11620001935780635594053d116200015d5780635594053d146200054b5780636846992a146200058a57806371df76781462000643578063741579b114620001ff57620001fa565b80633a82fd5e146200031e5780633b58524d146200036557806344842f4614620003a45780635274ac3f146200040257620001fa565b8063158ef93e11620001d5578063158ef93e146200028d57806315de360e14620002b9578063303a4a4614620002d15780633a5381b5146200030657620001fa565b806303fab4f614620001ff578063136ec0b3146200022957806314f64c781462000243575b600080fd5b3480156200020c57600080fd5b506200021762000915565b60408051918252519081900360200190f35b3480156200023657600080fd5b506200024162000921565b005b3480156200025057600080fd5b5062000271600480360360208110156200026957600080fd5b503562000b6c565b604080516001600160a01b039092168252519081900360200190f35b3480156200029a57600080fd5b50620002a562000b94565b604080519115158252519081900360200190f35b348015620002c657600080fd5b506200021762000b9d565b348015620002de57600080fd5b50620002e962000b9d565b6040805167ffffffffffffffff9092168252519081900360200190f35b3480156200031357600080fd5b506200027162000ba2565b3480156200032b57600080fd5b506200034f600480360360208110156200034457600080fd5b503560ff1662000bb6565b6040805160ff9092168252519081900360200190f35b3480156200037257600080fd5b5062000241600480360360408110156200038b57600080fd5b506001600160a01b038135811691602001351662000bcb565b348015620003b157600080fd5b50620003d560048036036020811015620003ca57600080fd5b503560ff1662000c03565b604080516001600160a01b03948516815292909316602083015260ff168183015290519081900360600190f35b3480156200040f57600080fd5b5062000241600480360360608110156200042857600080fd5b8101906020810181356401000000008111156200044457600080fd5b8201836020820111156200045757600080fd5b803590602001918460208302840111640100000000831117156200047a57600080fd5b9190808060200260200160405190810160405280939291908181526020018383602002808284376000920191909152509295949360208101935035915050640100000000811115620004cb57600080fd5b820183602082011115620004de57600080fd5b803590602001918460208302840111640100000000831117156200050157600080fd5b919080806020026020016040519081016040528093929190818152602001838360200280828437600092019190915250929550505090356001600160a01b0316915062000c359050565b3480156200055857600080fd5b5062000241600480360360408110156200057157600080fd5b506001600160a01b038135169060200135151562000fcc565b3480156200059757600080fd5b506200024160048036036040811015620005b057600080fd5b810190602081018135640100000000811115620005cc57600080fd5b820183602082011115620005df57600080fd5b803590602001918460208302840111640100000000831117156200060257600080fd5b9190808060200260200160405190810160405280939291908181526020018383602002808284376000920191909152509295505091359250620010e7915050565b3480156200065057600080fd5b506200024162001578565b3480156200066857600080fd5b5062000271600480360360208110156200068157600080fd5b50356001600160a01b031662001707565b3480156200069f57600080fd5b506200024160048036036020811015620006b857600080fd5b50356001600160a01b031662001722565b348015620006d657600080fd5b506200027160048036036080811015620006ef57600080fd5b506001600160a01b03813581169160208101359091169060ff60408201358116916060013516620017bf565b3480156200072857600080fd5b5062000241600480360360808110156200074157600080fd5b5060ff81358116916020810135821691604082013581169160600135166200196f565b3480156200077157600080fd5b506200021762001b1b565b3480156200078957600080fd5b506200079462001b27565b60408051602080825283518183015283519192839290830191858101910280838360005b83811015620007d2578181015183820152602001620007b8565b505050509050019250505060405180910390f35b348015620007f357600080fd5b5062000271600480360360208110156200080c57600080fd5b503562001e2b565b3480156200082157600080fd5b506200024162001e39565b3480156200083957600080fd5b50620002416200207f565b3480156200085157600080fd5b506200085c620020e4565b6040805161ffff9092168252519081900360200190f35b62000241620020e9565b3480156200088a57600080fd5b506200034f60048036036020811015620008a357600080fd5b503560ff166200237d565b348015620008bb57600080fd5b506200021760048036036020811015620008d457600080fd5b50356001600160a01b031662002392565b348015620008f257600080fd5b5062000271620023a4565b3480156200090a57600080fd5b5062000271620023b3565b670de0b6b3a764000081565b6000339050806001600160a01b031660076000836001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b1580156200096e57600080fd5b505afa15801562000983573d6000803e3d6000fd5b505050506040513d60208110156200099a57600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462000a07576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b336001816001600160a01b031663c19d93fb6040518163ffffffff1660e01b815260040160206040518083038186803b15801562000a4457600080fd5b505afa15801562000a59573d6000803e3d6000fd5b505050506040513d602081101562000a7057600080fd5b5051600381111562000a7e57fe5b1462000ac3576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600060096000836001600160a01b031663ed7ba8986040518163ffffffff1660e01b815260040160206040518083038186803b15801562000b0357600080fd5b505afa15801562000b18573d6000803e3d6000fd5b505050506040513d602081101562000b2f57600080fd5b5051600181111562000b3d57fe5b600181111562000b4957fe5b81526020810191909152604001600020905062000b678133620023c2565b505050565b6005818154811062000b7a57fe5b6000918252602090912001546001600160a01b0316905081565b60005460ff1681565b600081565b60005461010090046001600160a01b031681565b60036020526000908152604090205460ff1681565b60008054610100600160a81b0319166101006001600160a01b0394851602179055600180546001600160a01b03191691909216179055565b600960205260009081526040902080546001909101546001600160a01b0391821691811690600160a01b900460ff1683565b6000805460ff1916600117905582511580159062000c54575081518351145b62000c97576040805162461bcd60e51b815260206004820152600e60248201526d496e76616c696420706172616d7360901b604482015290519081900360640190fd5b6001600160a01b03811662000ceb576040805162461bcd60e51b8152602060048201526015602482015274496e76616c69642061646d696e206164647265737360581b604482015290519081900360640190fd5b600280546001600160a01b0319166001600160a01b0383161790557f3617319a054d772f909f7c479a2cebe5066e836a939412e32403c99029b92eff805460ff19908116909155600160009081527fa15bc60c955c405d20d9149c709e2460f1c2d9a497496a7f46004d1772c3054c8054601590841617905560046020527f17ef568e3e12ab5b9c7254a8d58478811de00f9e6eb34345acd53bf8fd09d3ec8054831690557fabd6e7cb50984ff9c2f3e18a2660c3353dadf4e3291deeb275dae2cd1e44fe0580549092169091555b83518160ff16101562000fc6576000848260ff168151811062000dd957fe5b6020908102919091018101516001600160a01b0380821660009081526007909352604090922054909250161562000e52576040805162461bcd60e51b815260206004820152601860248201527743616e64696461746520616c72656164792065786973747360401b604482015290519081900360640190fd5b60008182606460018060405162000e699062003097565b80866001600160a01b03168152602001856001600160a01b0316815260200184815260200183600181111562000e9b57fe5b815260200182600381111562000ead57fe5b815260200195505050505050604051809103906000f08015801562000ed6573d6000803e3d6000fd5b506001600160a01b0383811660009081526007602052604080822080546001600160a01b03191693851693841790558051633b58524d60e01b81523060048201526024810183905290519394509192633b58524d92604480820193929182900301818387803b15801562000f4957600080fd5b505af115801562000f5e573d6000803e3d6000fd5b50505050806001600160a01b0316638129fc1c6040518163ffffffff1660e01b8152600401600060405180830381600087803b15801562000f9e57600080fd5b505af115801562000fb3573d6000803e3d6000fd5b50506001909401935062000dba92505050565b50505050565b6002546001600160a01b0316331462001019576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b6001600160a01b0382811660009081526007602052604090205416620010715760405162461bcd60e51b815260040180806020018281038252602181526020018062004f456021913960400191505060405180910390fd5b6001600160a01b03808316600090815260076020526040808220548151638ec7a23d60e01b815285151560048201529151931692638ec7a23d9260248084019391929182900301818387803b158015620010ca57600080fd5b505af1158015620010df573d6000803e3d6000fd5b505050505050565b33411462001129576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600a60209081526040808320600180855292529091205460ff16156200118f576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481bdc195c985d195960821b604482015290519081900360640190fd5b818043816200119a57fe5b0615620011e1576040805162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015290519081900360640190fd5b436000908152600a60209081526040808320600180855292528220805460ff191690911790555b60055460ff821610156200126d576000600b600060058460ff16815481106200122d57fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805460ff191660ff9290921691909117905560010162001208565b50835162001283906005906020870190620030a5565b5060005b60055460ff82161015620012ec576001600b600060058460ff1681548110620012ac57fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805460ff191660ff9290921691909117905560010162001287565b5060005b60065460ff8216101562001333576006805460001981019081106200131157fe5b600091825260209091200180546001600160a01b0319169055600101620012f0565b506200133e6200310f565b50604080518082019091526000808252600160208301525b60028160ff161015620010df57600060046000848460ff16600281106200137957fe5b602002015160018111156200138a57fe5b60018111156200139657fe5b815260200190815260200160002060009054906101000a900460ff169050600060096000858560ff1660028110620013ca57fe5b60200201516001811115620013db57fe5b6001811115620013e757fe5b8152602081019190915260400160002080549091506001600160a01b03165b6001600160a01b038116156200156c57600b6000826001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b1580156200145457600080fd5b505afa15801562001469573d6000803e3d6000fd5b505050506040513d60208110156200148057600080fd5b50516001600160a01b0316815260208101919091526040016000205460ff1662001549576006816001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b158015620014e057600080fd5b505afa158015620014f5573d6000803e3d6000fd5b505050506040513d60208110156200150c57600080fd5b505181546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b0390921691909117905560001992909201915b6001600160a01b0390811660009081526003830160205260409020541662001406565b50505060010162001356565b6000339050806001600160a01b031660076000836001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b158015620015c557600080fd5b505afa158015620015da573d6000803e3d6000fd5b505050506040513d6020811015620015f157600080fd5b50516001600160a01b03908116825260208201929092526040016000205416146200165e576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b6000339050600060096000836001600160a01b031663ed7ba8986040518163ffffffff1660e01b815260040160206040518083038186803b158015620016a357600080fd5b505afa158015620016b8573d6000803e3d6000fd5b505050506040513d6020811015620016cf57600080fd5b50516001811115620016dd57fe5b6001811115620016e957fe5b81526020810191909152604001600020905062000b67818362002982565b6007602052600090815260409020546001600160a01b031681565b6002546001600160a01b031633146200176f576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b600280546001600160a01b0319166001600160a01b0383811691909117918290556040519116907f927cc064d7b7fa546fa7706bc01845d27d06f15af3ae90a672cc44735928e96190600090a250565b6002546000906001600160a01b031633146200180f576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b6001600160a01b03858116600090815260076020526040902054161562001878576040805162461bcd60e51b815260206004820152601860248201527743616e64696461746520616c72656164792065786973747360401b604482015290519081900360640190fd5b60008585858560006040516200188e9062003097565b80866001600160a01b03168152602001856001600160a01b031681526020018460ff168152602001836001811115620018c357fe5b8152602001826003811115620018d557fe5b815260200195505050505050604051809103906000f080158015620018fe573d6000803e3d6000fd5b506001600160a01b0387811660008181526007602090815260409182902080546001600160a01b03191694861694851790558151938452905193945090927faa09247a2eedc4269bc491bbe4eb4f35da3a820e053f362953f56884adecab199281900390910190a295945050505050565b6002546001600160a01b03163314620019bc576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60ff8483011660151462001a08576040805162461bcd60e51b815260206004820152600e60248201526d496e76616c696420706172616d7360901b604482015290519081900360640190fd5b7f3617319a054d772f909f7c479a2cebe5066e836a939412e32403c99029b92eff805460ff86811660ff1992831681179093557fa15bc60c955c405d20d9149c709e2460f1c2d9a497496a7f46004d1772c3054c80548683169084168117909155600460209081527f17ef568e3e12ab5b9c7254a8d58478811de00f9e6eb34345acd53bf8fd09d3ec8054851689851690811790915560016000527fabd6e7cb50984ff9c2f3e18a2660c3353dadf4e3291deeb275dae2cd1e44fe0580549095169387169384179094556040805195865290850193909352838301526060830152517fef8fc40942f0314a9f5ebd7832ff1b78e6c4b5b7062355066b0c0e3e0edc6f29916080908290030190a150505050565b674563918244f4000081565b6060600062001b356200310f565b50604080518082019091526000808252600160208301525b60028160ff16101562001c48576000828260ff166002811062001b6c57fe5b6020020151905060006009600083600181111562001b8657fe5b600181111562001b9257fe5b815260200190815260200160002090506003600083600181111562001bb357fe5b600181111562001bbf57fe5b8152602081019190915260400160002054600182015460ff918216600160a01b909104909116101562001c06576001810154600160a01b900460ff16949094019362001c3d565b6003600083600181111562001c1757fe5b600181111562001c2357fe5b815260208101919091526040016000205460ff1694909401935b505060010162001b4d565b5060608260ff1667ffffffffffffffff8111801562001c6657600080fd5b5060405190808252806020026020018201604052801562001c91578160200160208202803683370190505b50905060005b60028160ff16101562001e23576000838260ff166002811062001cb657fe5b6020020151905060006009600083600181111562001cd057fe5b600181111562001cdc57fe5b8152602001908152602001600020905060006003600084600181111562001cff57fe5b600181111562001d0b57fe5b81526020810191909152604001600090812054835460ff90911692506001600160a01b0316905b60008360ff1611801562001d4e57506001600160a01b03821615155b1562001e1157816001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b15801562001d8e57600080fd5b505afa15801562001da3573d6000803e3d6000fd5b505050506040513d602081101562001dba57600080fd5b50518751889060ff841690811062001dce57fe5b6001600160a01b03928316602091820292909201810191909152928116600090815260038601909352604090922054600019909301929091169060010162001d32565b50506001909301925062001c97915050565b509250505090565b6006818154811062000b7a57fe5b6000339050806001600160a01b031660076000836001600160a01b0316636c8381f86040518163ffffffff1660e01b815260040160206040518083038186803b15801562001e8657600080fd5b505afa15801562001e9b573d6000803e3d6000fd5b505050506040513d602081101562001eb257600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462001f1f576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b336001816001600160a01b031663c19d93fb6040518163ffffffff1660e01b815260040160206040518083038186803b15801562001f5c57600080fd5b505afa15801562001f71573d6000803e3d6000fd5b505050506040513d602081101562001f8857600080fd5b5051600381111562001f9657fe5b1462001fdb576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600060096000836001600160a01b031663ed7ba8986040518163ffffffff1660e01b815260040160206040518083038186803b1580156200201b57600080fd5b505afa15801562002030573d6000803e3d6000fd5b505050506040513d60208110156200204757600080fd5b505160018111156200205557fe5b60018111156200206157fe5b81526020810191909152604001600020905062000b67818362002b77565b33600090815260086020526040902054806200209c5750620020e2565b3360008181526008602052604080822082905580516379b6053960e11b8152905163f36c0a729285926004808201939182900301818588803b158015620010ca57600080fd5b565b601581565b3341146200212b576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600a6020908152604080832083805290915281205460ff16156200218f576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481bdc195c985d195960821b604482015290519081900360640190fd5b436000908152600a602090815260408083208380529091528120805460ff19166001179055805b60055460ff8216101562002274576007600060058360ff1681548110620021d957fe5b60009182526020808320909101546001600160a01b03908116845283820194909452604092830190912054825163f1cea4c760e01b8152925193169263f1cea4c7926004808201939291829003018186803b1580156200223857600080fd5b505afa1580156200224d573d6000803e3d6000fd5b505050506040513d60208110156200226457600080fd5b50519190910190600101620021b6565b508015620023795760005b60055460ff8216101562000b675760006007600060058460ff1681548110620022a457fe5b60009182526020808320909101546001600160a01b03908116845283820194909452604092830190912054825163f1cea4c760e01b81529251931693506200235092869262002349923492879263f1cea4c7926004808301939192829003018186803b1580156200231457600080fd5b505afa15801562002329573d6000803e3d6000fd5b505050506040513d60208110156200234057600080fd5b50519062002f4b565b9062002fb2565b6001600160a01b039091166000908152600860205260409020805490910190556001016200227f565b5050565b60046020526000908152604090205460ff1681565b60086020526000908152604090205481565b6001546001600160a01b031681565b6002546001600160a01b031681565b6001820154600160a01b900460ff16620024275781546001600160a01b0382166001600160a01b0319918216811784556001808501805460ff600160a01b91909516909317838104851690920190931690910260ff60a01b1990911617905562002379565b81546001600160a01b0382811691161415620024435762002379565b6001600160a01b0380821660009081526002840160205260409020541680620025ec576001808401805460ff600160a01b80830482169094011690920260ff60a01b1990921691909117908190556040805163f1cea4c760e01b815290516001600160a01b039092169163f1cea4c791600480820192602092909190829003018186803b158015620024d457600080fd5b505afa158015620024e9573d6000803e3d6000fd5b505050506040513d60208110156200250057600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b1580156200254357600080fd5b505afa15801562002558573d6000803e3d6000fd5b505050506040513d60208110156200256f57600080fd5b505111620025d757506001820180546001600160a01b038381166000818152600287016020908152604080832080549686166001600160a01b031997881617905586549094168252600388019052919091208054831682179055825490911617905562002379565b5060018201546001600160a01b031662002783565b806001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b1580156200262657600080fd5b505afa1580156200263b573d6000803e3d6000fd5b505050506040513d60208110156200265257600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b1580156200269557600080fd5b505afa158015620026aa573d6000803e3d6000fd5b505050506040513d6020811015620026c157600080fd5b505111620026d0575062002379565b6001600160a01b038083166000818152600386016020526040808220548585168352912080546001600160a01b031916918416919091179055600185015490911614156200273b576001830180546001600160a01b0319166001600160a01b03831617905562002783565b6001600160a01b03808316600090815260028501602081815260408084205460038901835281852054861685529290915290912080546001600160a01b031916919092161790555b6001600160a01b03811615801590620028705750806001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b158015620027d157600080fd5b505afa158015620027e6573d6000803e3d6000fd5b505050506040513d6020811015620027fd57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b1580156200284057600080fd5b505afa15801562002855573d6000803e3d6000fd5b505050506040513d60208110156200286c57600080fd5b5051115b1562002899576001600160a01b0390811660009081526002840160205260409020541662002783565b6001600160a01b03811662002910575081546001600160a01b038281166000818152600386016020908152604080832080549686166001600160a01b031997881617905587549094168252600287019052828120805485168317905581815291909120805483169055835490911617825562002379565b6001600160a01b0390811660008181526003850160209081526040808320805496861680855282852080549888166001600160a01b0319998a16179055815490961684526002909701909152808220805486168517905585548516841790955591825292902080549091169091179055565b81546001600160a01b03828116911614801590620029ba57506001600160a01b03818116600090815260028401602052604090205416155b15620029c65762002379565b60018201546001600160a01b038281169116141562002a13576001600160a01b0380821660009081526002840160205260409020546001840180546001600160a01b031916919092161790555b81546001600160a01b038281169116141562002a57576001600160a01b03808216600090815260038401602052604090205483546001600160a01b03191691161782555b6001600160a01b03808216600090815260038401602052604090205416801562002ab3576001600160a01b038083166000908152600285016020526040808220548484168352912080546001600160a01b031916919092161790555b6001600160a01b03808316600090815260028501602052604090205416801562002b0f576001600160a01b038084166000908152600386016020526040808220548484168352912080546001600160a01b031916919092161790555b50506001600160a01b03166000908152600282016020908152604080832080546001600160a01b03199081169091556003850190925290912080549091169055600101805460ff60a01b198116600160a01b9182900460ff9081166000190116909102179055565b6001600160a01b03808216600081815260038501602052604090205460018501549083169216148062002bb157506001600160a01b038116155b8062002c925750816001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b15801562002bf257600080fd5b505afa15801562002c07573d6000803e3d6000fd5b505050506040513d602081101562002c1e57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0384169163f1cea4c7916004808301926020929190829003018186803b15801562002c6157600080fd5b505afa15801562002c76573d6000803e3d6000fd5b505050506040513d602081101562002c8d57600080fd5b505111155b1562002c9f575062002379565b6001600160a01b038083166000818152600286016020526040808220548585168352912080546001600160a01b0319169184169190911790558454909116141562002d035782546001600160a01b0319166001600160a01b03821617835562002d45565b6001600160a01b0382811660009081526002850160209081526040808320548416835260038701909152902080546001600160a01b0319169183169190911790555b6001600160a01b0381161580159062002e325750816001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b15801562002d9357600080fd5b505afa15801562002da8573d6000803e3d6000fd5b505050506040513d602081101562002dbf57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0384169163f1cea4c7916004808301926020929190829003018186803b15801562002e0257600080fd5b505afa15801562002e17573d6000803e3d6000fd5b505050506040513d602081101562002e2e57600080fd5b5051115b1562002e5b576001600160a01b0390811660009081526003840160205260409020541662002d45565b6001600160a01b03811662002ed3576001830180546001600160a01b038481166000818152600288016020908152604080832080549686166001600160a01b031997881617905560038a0190915280822080548616905585549093168152919091208054831682179055825490911617905562000b67565b6001600160a01b0390811660008181526002850160208181526040808420805487168552600390980180835281852080546001600160a01b0319908116998916998a17909155848452895489875283872080549190991690821617909755825283208054861685179055929091529052825416179055565b60008262002f5c5750600062002fac565b8282028284828162002f6a57fe5b041462002fa95760405162461bcd60e51b815260040180806020018281038252602181526020018062004f666021913960400191505060405180910390fd5b90505b92915050565b600062002fa983836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525060008183620030805760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015620030445781810151838201526020016200302a565b50505050905090810190601f168015620030725780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060008385816200308d57fe5b0495945050505050565b611df6806200314f83390190565b828054828255906000526020600020908101928215620030fd579160200282015b82811115620030fd57825182546001600160a01b0319166001600160a01b03909116178255602090920191600190910190620030c6565b506200310b9291506200312d565b5090565b60405180604001604052806002906020820280368337509192915050565b5b808211156200310b5780546001600160a01b03191681556001016200312e56fe608060405234801561001057600080fd5b50604051611df6380380611df6833981810160405260a081101561003357600080fd5b5080516020820151604083015160608401516080909401519293919290919060ff83168061009a576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b6103e88161ffff1611156100e7576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600280546001600160a01b038089166001600160a01b03199283161790925560038054928816929091169190911790556005805461ffff191660ff86161790556001805484919060ff60a01b1916600160a01b838381111561014557fe5b02179055506001805483919060ff60a81b1916600160a81b83600381111561016957fe5b0217905550505050505050611c73806101836000396000f3fe60806040526004361061020f5760003560e01c80639001eed811610118578063c885bc58116100a0578063e9fad8ee1161006f578063e9fad8ee146105ca578063ed7ba898146105df578063f1cea4c714610604578063f36c0a7214610619578063f5323feb146106215761020f565b8063c885bc5814610577578063c967f90f1461057f578063ce42ae1b14610594578063d0e30db0146105c25761020f565b8063a3ec138d116100e7578063a3ec138d14610475578063a3fbbaae146104c6578063a6606679146104f9578063be10c7f21461050e578063c19d93fb146105415761020f565b80639001eed814610421578063939d6237146104365780639e83d5b11461044b578063a1109b43146104605761020f565b8063481c6a751161019b578063741579b11161016a578063741579b1146102145780638129fc1c146103b6578063826d3dec146103cb5780638ec7a23d146103e05780638f76691a1461040c5761020f565b8063481c6a7514610358578063483a00e81461036d5780636c8381f81461037557806370ba11131461038a5761020f565b806324c5b1ca116101e257806324c5b1ca1461028e578063303a4a46146102a35780633a5381b5146102d55780633b58524d146103065780633ccfd60b146103435761020f565b806303fab4f614610214578063158ef93e1461023b57806315de360e14610264578063228cb73314610279575b600080fd5b34801561022057600080fd5b50610229610636565b60408051918252519081900360200190f35b34801561024757600080fd5b50610250610642565b604080519115158252519081900360200190f35b34801561027057600080fd5b5061022961064b565b34801561028557600080fd5b50610229610650565b34801561029a57600080fd5b50610229610656565b3480156102af57600080fd5b506102b861064b565b6040805167ffffffffffffffff9092168252519081900360200190f35b3480156102e157600080fd5b506102ea61065c565b604080516001600160a01b039092168252519081900360200190f35b34801561031257600080fd5b506103416004803603604081101561032957600080fd5b506001600160a01b0381358116916020013516610670565b005b34801561034f57600080fd5b506103416106a8565b34801561036457600080fd5b506102ea610897565b6103416108a6565b34801561038157600080fd5b506102ea610b26565b34801561039657600080fd5b5061039f610b35565b6040805161ffff9092168252519081900360200190f35b3480156103c257600080fd5b50610341610b3f565b3480156103d757600080fd5b50610341610baa565b3480156103ec57600080fd5b506103416004803603602081101561040357600080fd5b50351515610cb6565b34801561041857600080fd5b50610229610e35565b34801561042d57600080fd5b50610229610e3b565b34801561044257600080fd5b50610229610e47565b34801561045757600080fd5b50610341610e4d565b34801561046c57600080fd5b50610229610fbb565b34801561048157600080fd5b506104a86004803603602081101561049857600080fd5b50356001600160a01b0316610fc1565b60408051938452602084019290925282820152519081900360600190f35b3480156104d257600080fd5b50610341600480360360208110156104e957600080fd5b50356001600160a01b0316610fe2565b34801561050557600080fd5b50610341611084565b34801561051a57600080fd5b50610523611222565b6040805161ffff909316835260208301919091528051918290030190f35b34801561054d57600080fd5b50610556611232565b6040518082600381111561056657fe5b815260200191505060405180910390f35b610341611242565b34801561058b57600080fd5b5061039f6113ba565b3480156105a057600080fd5b50610341600480360360208110156105b757600080fd5b503561ffff166113bf565b6103416114f3565b3480156105d657600080fd5b50610341611740565b3480156105eb57600080fd5b506105f46118d4565b6040518082600181111561056657fe5b34801561061057600080fd5b506102296118e4565b6103416118ea565b34801561062d57600080fd5b506102ea6119b1565b670de0b6b3a764000081565b60005460ff1681565b600081565b60065481565b600b5481565b60005461010090046001600160a01b031681565b60008054610100600160a81b0319166101006001600160a01b0394851602179055600180546001600160a01b03191691909216179055565b336000526007602052600060019054906101000a90046001600160a01b03166001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561070157600080fd5b505af1158015610715573d6000803e3d6000fd5b50503360009081526007602052604081206001810154905460085492945061075d9350909161075791670de0b6b3a764000091610751916119c0565b90611a22565b90611a64565b3360009081526007602052604090205460095491925061077d9190611a64565b600955336000908152600760205260408120805482825560019182019290925590820190600154600160a81b900460ff1660038111156107b957fe5b141561082857600060019054906101000a90046001600160a01b03166001600160a01b031663bb8b65af6040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561080f57600080fd5b505af1158015610823573d6000803e3d6000fd5b505050505b801561089357604051339082156108fc029083906000818181858888f1935050505015801561085b573d6000803e3d6000fd5b5060408051828152905133917f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364919081900360200190a25b5050565b6003546001600160a01b031681565b6003546001600160a01b031633146108fc576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b6000600154600160a81b900460ff16600381111561091657fe5b148061094857506003600154600160a81b900460ff16600381111561093757fe5b14801561094857506000600a544303115b61098b576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600b541580610998575060015b6109e4576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b6004805434908101909155604080519182525133917f278e696bd0cd4a7d1260ced26c40cd01c2b088f441889e4148240ac81069b348919081900360200190a260006001808054600160a01b900460ff1690811115610a3f57fe5b1415610a545750670de0b6b3a7640000610a5f565b50674563918244f400005b8060045410610b23576001805460ff60a81b1916600160a81b1790819055600254604080516363e1d45160e01b81526001600160a01b039283166004820152905191909216916363e1d45191602480830192600092919082900301818387803b158015610acb57600080fd5b505af1158015610adf573d6000803e3d6000fd5b50505050600080516020611bfd833981519152600160159054906101000a900460ff1660405180826003811115610b1257fe5b815260200191505060405180910390a15b50565b6002546001600160a01b031681565b60055461ffff1681565b60008054600160ff19909116178082556040805163136ec0b360e01b815290516101009092046001600160a01b03169263136ec0b39260048084019382900301818387803b158015610b9057600080fd5b505af1158015610ba4573d6000803e3d6000fd5b50505050565b670de0b6b3a76400006004541015610c01576040805162461bcd60e51b8152602060048201526015602482015274139bc8195b9bdd59da081b585c99da5b881b19599d605a1b604482015290519081900360640190fd5b43600a556001805460ff60a81b1916600360a81b1790556000805460408051630e3beecf60e31b815290516101009092046001600160a01b0316926371df76789260048084019382900301818387803b158015610c5d57600080fd5b505af1158015610c71573d6000803e3d6000fd5b505060048054670de0b6b3a763ffff1901905550506040516000908190670de0b6b3a76400009082818181858280f19350505050158015610b23573d6000803e3d6000fd5b808015610cfa57506000600154600160a81b900460ff166003811115610cd857fe5b1480610cfa575060018054600160a81b900460ff166003811115610cf857fe5b145b15610dbc576001805460ff60a81b1916600160a91b1790819055604051600080516020611bfd83398151915291600160a81b900460ff169080826003811115610d3f57fe5b815260200191505060405180910390a1600060019054906101000a90046001600160a01b03166001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610d9f57600080fd5b505af1158015610db3573d6000803e3d6000fd5b50505050610b23565b80158015610de157506002600154600160a81b900460ff166003811115610ddf57fe5b145b15610b23576001805460ff60a81b191690819055604051600080516020611bfd83398151915291600160a81b900460ff169080826003811115610e2057fe5b815260200191505060405180910390a1610b23565b60045481565b674563918244f4000081565b60085481565b6003546001600160a01b03163314610ea3576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b6000600154600160a81b900460ff166003811115610ebd57fe5b14610f01576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600060045411610f49576040805162461bcd60e51b815260206004820152600e60248201526d27379036b7b9329036b0b933b4b760911b604482015290519081900360640190fd5b600480546000918290556040519091339183156108fc0291849190818181858888f19350505050158015610f81573d6000803e3d6000fd5b5060408051828152905133917f5d3b8fa9823b18b176cfe79e002a5b931b8569313802f700eb8550bc6a353246919081900360200190a250565b600a5481565b60076020526000908152604090208054600182015460029092015490919083565b6002546001600160a01b0316331461103a576040805162461bcd60e51b815260206004820152601660248201527513db9b1e4818d85b991a59185d1948185b1b1bddd95960521b604482015290519081900360640190fd5b600380546001600160a01b0319166001600160a01b0383169081179091556040517f5cd5185727f6057b7a274979ce4d902e15bf0ef1dc542d1fe5926cba874f63b690600090a250565b6003546001600160a01b031633146110da576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b600c5461ffff1680611125576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b6103e88161ffff161115611172576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600d5415801590611181575060015b6111cd576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b600c80546005805461ffff80841661ffff19928316179283905592169092556000600d81905560405192909116917fcac49e9849a8f10ab0094584f2be1e8fdeb0fc92f3867604d41aaf917b5cc4599190a250565b600c54600d5461ffff9091169082565b600154600160a81b900460ff1681565b6003546001600160a01b03163314611298576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b600060019054906101000a90046001600160a01b03166001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156112e857600080fd5b505af11580156112fc573d6000803e3d6000fd5b50505050600060065411611348576040805162461bcd60e51b815260206004820152600e60248201526d27379036b7b9329036b0b933b4b760911b604482015290519081900360640190fd5b600680546000918290556040519091339183156108fc0291849190818181858888f19350505050158015611380573d6000803e3d6000fd5b5060408051828152905133917fbc84835063c693975166f00cffb19f01a94c2db55b1bf259238c5da3594e5066919081900360200190a250565b601581565b6003546001600160a01b03163314611415576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b8060008161ffff1611611461576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b6103e88161ffff1611156114ae576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600c805461ffff191661ffff841690811790915543600d556040517f6f8588849b25baa50ffb5a79a8457f6111569a911a0cf6aca2bdc521365ab3ef90600090a25050565b600060019054906101000a90046001600160a01b03166001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561154357600080fd5b505af1158015611557573d6000803e3d6000fd5b5050336000908152600760205260408120600181015490546008549294506115939350909161075791670de0b6b3a764000091610751916119c0565b905034156116cf57336000908152600760205260409020546115b59034611aa6565b336000908152600760205260409020818155436002909101556008546115e991670de0b6b3a76400009161075191906119c0565b336000908152600760205260409020600101556009546116099034611aa6565b60095560018054600160a81b900460ff16600381111561162557fe5b141561169457600060019054906101000a90046001600160a01b03166001600160a01b031663136ec0b36040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561167b57600080fd5b505af115801561168f573d6000803e3d6000fd5b505050505b60408051348152905133917fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c919081900360200190a261170d565b600854336000908152600760205260409020546116f991670de0b6b3a764000091610751916119c0565b336000908152600760205260409020600101555b8015610b2357604051339082156108fc029083906000818181858888f19350505050158015611380573d6000803e3d6000fd5b6003546001600160a01b03163314611796576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b60018054600160a81b900460ff1660038111156117af57fe5b146117f3576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b43600b556001805460ff60a81b191690819055604051600080516020611bfd83398151915291600160a81b900460ff16908082600381111561183157fe5b815260200191505060405180910390a1600060019054906101000a90046001600160a01b03166001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561189157600080fd5b505af11580156118a5573d6000803e3d6000fd5b50506040517f04311d55cecee233de1d4a7873cccf1ee3ba3128bddaea86d4f03c2dd359f0c1925060009150a1565b600154600160a01b900460ff1681565b60095481565b600554600090611907906103e89061075190349061ffff166119c0565b60068054820190556009549091506119429061193990610751670de0b6b3a76400006119333487611a64565b906119c0565b60085490611aa6565b6008819055600954479161196391670de0b6b3a764000091610751916119c0565b600654011115610b23576040805162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b604482015290519081900360640190fd5b6001546001600160a01b031681565b6000826119cf57506000611a1c565b828202828482816119dc57fe5b0414611a195760405162461bcd60e51b8152600401808060200182810382526021815260200180611c1d6021913960400191505060405180910390fd5b90505b92915050565b6000611a1983836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250611b00565b6000611a1983836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250611ba2565b600082820183811015611a19576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b60008183611b8c5760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015611b51578181015183820152602001611b39565b50505050905090810190601f168015611b7e5780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b506000838581611b9857fe5b0495945050505050565b60008184841115611bf45760405162461bcd60e51b8152602060048201818152835160248401528351909283926044909101919085019080838360008315611b51578181015183820152602001611b39565b50505090039056fe402ee26d4c255fcb07b0b7b5b93b77377832260977c25be44f3c8feffd2df70e536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a2646970667358221220c9a9b8692cd3522d32d7241dfc9beab818469c15872e95e7c51da0a97a36f96f64736f6c634300060c0033436f72726573706f6e64696e672063616e646964617465206e6f7420666f756e64536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a2646970667358221220269f9a9d8eaa3a442810e5fbf13d4fdd4c3583b7edfa49754150859f46543efc64736f6c634300060c0033"
)

type hardForkValidatorsV1 struct {
}

func (s *hardForkValidatorsV1) GetName() string {
	return ValidatorsV1ContractName
}

func (s *hardForkValidatorsV1) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV1Code)

	//write code to sys contract
	state.SetCode(ValidatorsV1ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV1ContractAddr.String(), "code", validatorV1Code)

	return
}

func (s *hardForkValidatorsV1) getAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return validatorV1Admin
	}

	return validatorV1AdminTestnet
}

func (s *hardForkValidatorsV1) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}
	managers := make([]common.Address, 0, len(topVals))
	for _, val := range topVals {
		feeAddr, err := v0.GetValidatorFeeAddr(val, state, header, chainContext, config)
		if err != nil {
			return err
		}
		managers = append(managers, feeAddr)
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV1ContractName].Pack(method, topVals, managers, s.getAdminByChainId(config.ChainID))
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := types.NewMessage(header.Coinbase, &ValidatorsV1ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
