package systemcontract

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
	"math"
	"math/big"
)

var (
	//TODO: set these to formal addresses
	validatorV1Admin        = common.HexToAddress("0x8Cc5A1a0802DB41DB826C2FcB72423744338DcB0")
	validatorV1AdminTestnet = common.HexToAddress("0x8Cc5A1a0802DB41DB826C2FcB72423744338DcB0")
)

const (
	validatorV1Code = "0x6080604052600436106200021e5760003560e01c80638fffcbd01162000127578063bcecf81b11620000af578063ec0cb3361162000079578063ec0cb3361462000293578063f04a5dcd1462000876578063f3b1cc671462000293578063f40f0f5214620008a7578063f851a44014620008de576200021e565b8063bcecf81b14620007f7578063c885bc581462000825578063c967f90f146200083d578063d6c0edad146200086c576200021e565b8063a4e98b8211620000f1578063a4e98b821462000718578063afeea1151462000776578063bb8b65af146200078e578063bbc7168014620007a6576200021e565b80638fffcbd014620006875780639001eed814620006d05780639cc02c3014620006e85780639de702581462000700576200021e565b80635274ac3f11620001ab57806371a1bb75116200017557806371a1bb75146200060857806371df76781462000620578063741579b114620006385780638f2839701462000650576200021e565b80635274ac3f146200036557806360544bf114620004ae57806365f69f9714620005185780636846992a146200054f576200021e565b80631c0ffaa211620001ed5780631c0ffaa214620002ab5780632e4f67e414620002935780633a82fd5e14620002ea57806344f999001462000331576200021e565b806303fab4f61462000223578063136ec0b3146200024d578063158ef93e146200026757806315de360e1462000293575b600080fd5b3480156200023057600080fd5b506200023b620008f6565b60408051918252519081900360200190f35b3480156200025a57600080fd5b506200026562000902565b005b3480156200027457600080fd5b506200027f62000b4d565b604080519115158252519081900360200190f35b348015620002a057600080fd5b506200023b62000b56565b348015620002b857600080fd5b506200026560048036036040811015620002d157600080fd5b506001600160a01b038135169060200135151562000b5b565b348015620002f757600080fd5b506200031b600480360360208110156200031057600080fd5b503560ff1662000c7b565b6040805160ff9092168252519081900360200190f35b3480156200033e57600080fd5b506200034962000c90565b604080516001600160a01b039092168252519081900360200190f35b3480156200037257600080fd5b5062000265600480360360608110156200038b57600080fd5b810190602081018135640100000000811115620003a757600080fd5b820183602082011115620003ba57600080fd5b80359060200191846020830284011164010000000083111715620003dd57600080fd5b91908080602002602001604051908101604052809392919081815260200183836020028082843760009201919091525092959493602081019350359150506401000000008111156200042e57600080fd5b8201836020820111156200044157600080fd5b803590602001918460208302840111640100000000831117156200046457600080fd5b919080806020026020016040519081016040528093929190818152602001838360200280828437600092019190915250929550505090356001600160a01b0316915062000c969050565b348015620004bb57600080fd5b50620004c66200108d565b60408051602080825283518183015283519192839290830191858101910280838360005b8381101562000504578181015183820152602001620004ea565b505050509050019250505060405180910390f35b3480156200052557600080fd5b5062000349600480360360208110156200053e57600080fd5b50356001600160a01b0316620010f1565b3480156200055c57600080fd5b5062000265600480360360408110156200057557600080fd5b8101906020810181356401000000008111156200059157600080fd5b820183602082011115620005a457600080fd5b80359060200191846020830284011164010000000083111715620005c757600080fd5b91908080602002602001604051908101604052809392919081815260200183836020028082843760009201919091525092955050913592506200110c915050565b3480156200061557600080fd5b5062000349620015bd565b3480156200062d57600080fd5b5062000265620015c3565b3480156200064557600080fd5b506200023b62001752565b3480156200065d57600080fd5b5062000265600480360360208110156200067657600080fd5b50356001600160a01b03166200175e565b3480156200069457600080fd5b506200026560048036036080811015620006ad57600080fd5b5060ff813581169160208101358216916040820135811691606001351662001806565b348015620006dd57600080fd5b506200023b62001a2d565b348015620006f557600080fd5b506200023b62001a39565b3480156200070d57600080fd5b50620004c662001a3f565b3480156200072557600080fd5b5062000749600480360360208110156200073e57600080fd5b503560ff1662001aa1565b604080516001600160a01b03948516815292909316602083015260ff168183015290519081900360600190f35b3480156200078357600080fd5b50620004c662001ad3565b3480156200079b57600080fd5b506200026562001dd6565b348015620007b357600080fd5b506200034960048036036080811015620007cc57600080fd5b5080356001600160a01b03908116916020810135909116906040810135906060013560ff166200201c565b3480156200080457600080fd5b5062000349600480360360208110156200081d57600080fd5b503562002206565b3480156200083257600080fd5b50620002656200222e565b3480156200084a57600080fd5b506200085562002296565b6040805161ffff9092168252519081900360200190f35b620002656200229b565b3480156200088357600080fd5b506200031b600480360360208110156200089c57600080fd5b503560ff16620027a5565b348015620008b457600080fd5b506200023b60048036036020811015620008cd57600080fd5b50356001600160a01b0316620027ba565b348015620008eb57600080fd5b5062000349620027cc565b671bc16d674ec8000081565b6000339050806001600160a01b031660076000836001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b1580156200094f57600080fd5b505afa15801562000964573d6000803e3d6000fd5b505050506040513d60208110156200097b57600080fd5b50516001600160a01b0390811682526020820192909252604001600020541614620009e8576040805162461bcd60e51b8152602060048201526018602482015277159bdd19481c1bdbdb081b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b336001816001600160a01b031663c19d93fb6040518163ffffffff1660e01b815260040160206040518083038186803b15801562000a2557600080fd5b505afa15801562000a3a573d6000803e3d6000fd5b505050506040513d602081101562000a5157600080fd5b5051600381111562000a5f57fe5b1462000aa4576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6000600a6000836001600160a01b031663683c529c6040518163ffffffff1660e01b815260040160206040518083038186803b15801562000ae457600080fd5b505afa15801562000af9573d6000803e3d6000fd5b505050506040513d602081101562000b1057600080fd5b5051600181111562000b1e57fe5b600181111562000b2a57fe5b81526020810191909152604001600020905062000b488183620027e0565b505050565b60005460ff1681565b606481565b60005461010090046001600160a01b0316331462000bad576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b6001600160a01b038281166000908152600760205260409020541662000c055760405162461bcd60e51b815260040180806020018281038252602181526020018062005ef26021913960400191505060405180910390fd5b6001600160a01b03808316600090815260076020526040808220548151638ec7a23d60e01b815285151560048201529151931692638ec7a23d9260248084019391929182900301818387803b15801562000c5e57600080fd5b505af115801562000c73573d6000803e3d6000fd5b505050505050565b60016020526000908152604090205460ff1681565b61f00681565b60005460ff161562000ce5576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b6000835111801562000cf8575081518351145b62000d3b576040805162461bcd60e51b815260206004820152600e60248201526d496e76616c696420706172616d7360901b604482015290519081900360640190fd5b6001600160a01b03811662000d8f576040805162461bcd60e51b8152602060048201526015602482015274496e76616c69642061646d696e206164647265737360581b604482015290519081900360640190fd5b60008054600160ff199091168117610100600160a81b0319166101006001600160a01b038516021782558180600181111562000dc757fe5b815260200190815260200160002060006101000a81548160ff021916908360ff16021790555060056001600060018081111562000e0057fe5b600181111562000e0c57fe5b81526020808201929092526040016000908120805460ff9490941660ff1994851617905560029091527fac33ff75c19e70fe83507db0d683fd3465c996598dc972688b7ace676c89077b805483169055600181527fe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e080549092169091555b83518160ff16101562001087576000848260ff168151811062000ea957fe5b6020908102919091018101516001600160a01b0380821660009081526007909352604090922054909250161562000f23576040805162461bcd60e51b815260206004820152601960248201527856616c696461746f727320616c72656164792065786973747360381b604482015290519081900360640190fd5b600081858460ff168151811062000f3657fe5b602002602001015161271060018060405162000f5290620035b5565b80866001600160a01b03168152602001856001600160a01b0316815260200184815260200183600181111562000f8457fe5b815260200182600381111562000f9657fe5b815260200195505050505050604051809103906000f08015801562000fbf573d6000803e3d6000fd5b5060068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b038086166001600160a01b031992831681179093556000928352600760205260408084208054928616929093168217909255815163204a7f0760e21b8152915193945092638129fc1c9260048084019391929182900301818387803b1580156200105f57600080fd5b505af115801562001074573d6000803e3d6000fd5b50506001909401935062000e8a92505050565b50505050565b60606004805480602002602001604051908101604052809291908181526020018280548015620010e757602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311620010c8575b5050505050905090565b6007602052600090815260409020546001600160a01b031681565b3341146200114e576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600b60209081526040808320600180855292529091205460ff1615620011b4576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481bdc195c985d195960821b604482015290519081900360640190fd5b81804381620011bf57fe5b061562001206576040805162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015290519081900360640190fd5b60005460ff166200124d576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b436000908152600b60209081526040808320600180855292528220805460ff191690911790555b60035460ff82161015620012d95760006005600060038460ff16815481106200129957fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805460ff191660ff9290921691909117905560010162001274565b508351620012ef906003906020870190620035c3565b5060005b60035460ff82161015620013585760016005600060038460ff16815481106200131857fe5b6000918252602080832091909101546001600160a01b031683528201929092526040019020805460ff191660ff92909216919091179055600101620012f3565b5062001367600460006200362d565b6200137162003650565b50604080518082019091526000808252600160208301525b60028160ff16101562000c7357600060026000848460ff1660028110620013ac57fe5b60200201516001811115620013bd57fe5b6001811115620013c957fe5b815260200190815260200160002060009054906101000a900460ff1690506000600a6000858560ff1660028110620013fd57fe5b602002015160018111156200140e57fe5b60018111156200141a57fe5b8152602081019190915260400160002080549091506001600160a01b03165b60008360ff161180156200145557506001600160a01b03811615155b15620015b15760056000826001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b1580156200149957600080fd5b505afa158015620014ae573d6000803e3d6000fd5b505050506040513d6020811015620014c557600080fd5b50516001600160a01b0316815260208101919091526040016000205460ff166200158e576004816001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b1580156200152557600080fd5b505afa1580156200153a573d6000803e3d6000fd5b505050506040513d60208110156200155157600080fd5b505181546001810183556000928352602090922090910180546001600160a01b0319166001600160a01b0390921691909117905560001992909201915b6001600160a01b0390811660009081526003830160205260409020541662001439565b50505060010162001389565b61f00581565b6000339050806001600160a01b031660076000836001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b1580156200161057600080fd5b505afa15801562001625573d6000803e3d6000fd5b505050506040513d60208110156200163c57600080fd5b50516001600160a01b0390811682526020820192909252604001600020541614620016a9576040805162461bcd60e51b8152602060048201526018602482015277159bdd19481c1bdbdb081b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b60003390506000600a6000836001600160a01b031663683c529c6040518163ffffffff1660e01b815260040160206040518083038186803b158015620016ee57600080fd5b505afa15801562001703573d6000803e3d6000fd5b505050506040513d60208110156200171a57600080fd5b505160018111156200172857fe5b60018111156200173457fe5b81526020810191909152604001600020905062000b48818362002d9e565b670de0b6b3a764000081565b60005461010090046001600160a01b03163314620017b0576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60008054610100600160a81b0319166101006001600160a01b03848116820292909217808455604051919004909116917f927cc064d7b7fa546fa7706bc01845d27d06f15af3ae90a672cc44735928e96191a250565b60005461010090046001600160a01b0316331462001858576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60ff84830116600514620018b3576040805162461bcd60e51b815260206004820152601860248201527f496e76616c69642076616c696461746f7220636f756e74730000000000000000604482015290519081900360640190fd5b8360ff168360ff1611158015620018d057508160ff168160ff1611155b6200191a576040805162461bcd60e51b8152602060048201526015602482015274496e76616c6964206261636b757020636f756e747360581b604482015290519081900360640190fd5b7fa6eef7e35abe7026729641147f7915573c7e97b47efa546f5f6e3230263bcb49805460ff86811660ff1992831681179093557fcc69885fda6bcc1a4ace058b4a62bf5e179ea78fd58a1ccd71c22cc9b688792f80548683169084168117909155600260209081527fac33ff75c19e70fe83507db0d683fd3465c996598dc972688b7ace676c89077b8054851689851690811790915560016000527fe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e080549095169387169384179094556040805195865290850193909352838301526060830152517fef8fc40942f0314a9f5ebd7832ff1b78e6c4b5b7062355066b0c0e3e0edc6f29916080908290030190a150505050565b6729a2241af62c000081565b60065490565b60606003805480602002602001604051908101604052809291908181526020018280548015620010e7576020028201919060005260206000209081546001600160a01b03168152600190910190602001808311620010c8575050505050905090565b600a60205260009081526040902080546001909101546001600160a01b0391821691811690600160a01b900460ff1683565b6060600062001ae162003650565b50604080518082019091526000808252600160208301525b60028160ff16101562001bf4576000828260ff166002811062001b1857fe5b602002015190506000600a600083600181111562001b3257fe5b600181111562001b3e57fe5b815260200190815260200160002090506001600083600181111562001b5f57fe5b600181111562001b6b57fe5b8152602081019190915260400160002054600182015460ff918216600160a01b909104909116101562001bb2576001810154600160a01b900460ff16949094019362001be9565b6001600083600181111562001bc357fe5b600181111562001bcf57fe5b815260208101919091526040016000205460ff1694909401935b505060010162001af9565b5060608260ff1667ffffffffffffffff8111801562001c1257600080fd5b5060405190808252806020026020018201604052801562001c3d578160200160208202803683370190505b5090506000805b60028160ff16101562001dcc576000848260ff166002811062001c6357fe5b602002015190506000600a600083600181111562001c7d57fe5b600181111562001c8957fe5b8152602001908152602001600020905060006001600084600181111562001cac57fe5b600181111562001cb857fe5b8152602081019190915260400160002054825460ff90911691506001600160a01b03165b60008260ff1611801562001cf857506001600160a01b03811615155b1562001dbb57806001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b15801562001d3857600080fd5b505afa15801562001d4d573d6000803e3d6000fd5b505050506040513d602081101562001d6457600080fd5b50518751889060ff891690811062001d7857fe5b6001600160a01b03928316602091820292909201810191909152918116600090815260038501909252604090912054600190960195600019909201911662001cdc565b50506001909201915062001c449050565b5090935050505090565b6000339050806001600160a01b031660076000836001600160a01b0316633a5381b56040518163ffffffff1660e01b815260040160206040518083038186803b15801562001e2357600080fd5b505afa15801562001e38573d6000803e3d6000fd5b505050506040513d602081101562001e4f57600080fd5b50516001600160a01b039081168252602082019290925260400160002054161462001ebc576040805162461bcd60e51b8152602060048201526018602482015277159bdd19481c1bdbdb081b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b336001816001600160a01b031663c19d93fb6040518163ffffffff1660e01b815260040160206040518083038186803b15801562001ef957600080fd5b505afa15801562001f0e573d6000803e3d6000fd5b505050506040513d602081101562001f2557600080fd5b5051600381111562001f3357fe5b1462001f78576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6000600a6000836001600160a01b031663683c529c6040518163ffffffff1660e01b815260040160206040518083038186803b15801562001fb857600080fd5b505afa15801562001fcd573d6000803e3d6000fd5b505050506040513d602081101562001fe457600080fd5b5051600181111562001ff257fe5b600181111562001ffe57fe5b81526020810191909152604001600020905062000b48818362002f93565b6000805461010090046001600160a01b031633146200206f576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b6001600160a01b038581166000908152600760205260409020541615620020d9576040805162461bcd60e51b815260206004820152601960248201527856616c696461746f727320616c72656164792065786973747360381b604482015290519081900360640190fd5b6000858585856000604051620020ef90620035b5565b80866001600160a01b03168152602001856001600160a01b031681526020018481526020018360018111156200212157fe5b81526020018260038111156200213357fe5b815260200195505050505050604051809103906000f0801580156200215c573d6000803e3d6000fd5b5060068054600181019091557ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b03808a166001600160a01b03199283168117909355600083815260076020908152604091829020805493871693909416831790935580519182525193945091927f1ab57f2e2a6e4069160cc6501d8012d93ed435770b1ed646f82482a2f7234ff49281900390910190a295945050505050565b600681815481106200221457fe5b6000918252602090912001546001600160a01b0316905081565b33600090815260096020526040902054806200224b575062002294565b336000818152600960205260408082208290558051600162c261b160e01b03198152905163ff3d9e4f9285926004808201939182900301818588803b15801562000c5e57600080fd5b565b600581565b334114620022dd576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b436000908152600b6020908152604080832083805290915281205460ff161562002341576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481bdc195c985d195960821b604482015290519081900360640190fd5b60005460ff1662002388576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b436000908152600b602090815260408083208380529091528120805460ff19166001179055600854340190620023cd6064620023c684600a62003367565b90620033ce565b90506000620023e46064620023c685602862003367565b90506000620023fb6064620023c686603262003367565b6004549091501562002605576000805b60045460ff82161015620024d257620024c76007600060048460ff16815481106200243257fe5b60009182526020808320909101546001600160a01b03908116845283820194909452604092830190912054825163f1cea4c760e01b8152925193169263f1cea4c7926004808201939291829003018186803b1580156200249157600080fd5b505afa158015620024a6573d6000803e3d6000fd5b505050506040513d6020811015620024bd57600080fd5b5051839062003412565b91506001016200240b565b508015620026035760005b60045460ff82161015620026015760006007600060048460ff16815481106200250257fe5b60009182526020808320909101546001600160a01b039081168452838201949094526040928301822054835163f1cea4c760e01b81529351941694509092620025a7928792620023c692879263f1cea4c7926004808301939192829003018186803b1580156200257157600080fd5b505afa15801562002586573d6000803e3d6000fd5b505050506040513d60208110156200259d57600080fd5b50518a9062003367565b6001600160a01b038316600090815260096020526040902054909150620025cf908262003412565b6001600160a01b038316600090815260096020526040902055620025f488826200346d565b97505050600101620024dd565b505b505b600354156200279c576000805b60035460ff821610156200264457620026396007600060038460ff16815481106200243257fe5b915060010162002612565b5060005b60035460ff82161015620027995760006007600060038460ff16815481106200266d57fe5b60009182526020808320909101546001600160a01b0390811684529083019390935260409091018120546003549216925090620026ac908690620033ce565b90508315620027425760006200273085620023c689866001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b158015620026fb57600080fd5b505afa15801562002710573d6000803e3d6000fd5b505050506040513d60208110156200272757600080fd5b50519062003367565b90506200273e828262003412565b9150505b6001600160a01b03821660009081526009602052604090205462002767908262003412565b6001600160a01b0383166000908152600960205260409020556200278c88826200346d565b9750505060010162002648565b50505b50505060085550565b60026020526000908152604090205460ff1681565b60096020526000908152604090205481565b60005461010090046001600160a01b031681565b6001820154600160a01b900460ff16620028455781546001600160a01b0382166001600160a01b0319918216811784556001808501805460ff600160a01b91909516909317838104851690920190931690910260ff60a01b1990911617905562002d9a565b81546001600160a01b0382811691161415620028615762002d9a565b6001600160a01b038082166000908152600284016020526040902054168062002a0a576001808401805460ff600160a01b80830482169094011690920260ff60a01b1990921691909117908190556040805163f1cea4c760e01b815290516001600160a01b039092169163f1cea4c791600480820192602092909190829003018186803b158015620028f257600080fd5b505afa15801562002907573d6000803e3d6000fd5b505050506040513d60208110156200291e57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b1580156200296157600080fd5b505afa15801562002976573d6000803e3d6000fd5b505050506040513d60208110156200298d57600080fd5b505111620029f557506001820180546001600160a01b038381166000818152600287016020908152604080832080549686166001600160a01b031997881617905586549094168252600388019052919091208054831682179055825490911617905562002d9a565b5060018201546001600160a01b031662002ba1565b806001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b15801562002a4457600080fd5b505afa15801562002a59573d6000803e3d6000fd5b505050506040513d602081101562002a7057600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b15801562002ab357600080fd5b505afa15801562002ac8573d6000803e3d6000fd5b505050506040513d602081101562002adf57600080fd5b50511162002aee575062002d9a565b6001600160a01b038083166000818152600386016020526040808220548585168352912080546001600160a01b0319169184169190911790556001850154909116141562002b59576001830180546001600160a01b0319166001600160a01b03831617905562002ba1565b6001600160a01b03808316600090815260028501602081815260408084205460038901835281852054861685529290915290912080546001600160a01b031916919092161790555b6001600160a01b0381161580159062002c8e5750806001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b15801562002bef57600080fd5b505afa15801562002c04573d6000803e3d6000fd5b505050506040513d602081101562002c1b57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0385169163f1cea4c7916004808301926020929190829003018186803b15801562002c5e57600080fd5b505afa15801562002c73573d6000803e3d6000fd5b505050506040513d602081101562002c8a57600080fd5b5051115b1562002cb7576001600160a01b0390811660009081526002840160205260409020541662002ba1565b6001600160a01b03811662002d2d5782546001600160a01b038381166000818152600387016020908152604080832080549686166001600160a01b031997881617905588549094168252600288019052828120805485168317905581815291909120805483169055845490911617835562000b48565b6001600160a01b0390811660008181526003850160209081526040808320805487871680865283862080549289166001600160a01b031993841617905582549097168552600289019093528184208054841687179055805483168617905593825292902080549092161790555b5050565b81546001600160a01b0382811691161480159062002dd657506001600160a01b03818116600090815260028401602052604090205416155b1562002de25762002d9a565b60018201546001600160a01b038281169116141562002e2f576001600160a01b0380821660009081526002840160205260409020546001840180546001600160a01b031916919092161790555b81546001600160a01b038281169116141562002e73576001600160a01b03808216600090815260038401602052604090205483546001600160a01b03191691161782555b6001600160a01b03808216600090815260038401602052604090205416801562002ecf576001600160a01b038083166000908152600285016020526040808220548484168352912080546001600160a01b031916919092161790555b6001600160a01b03808316600090815260028501602052604090205416801562002f2b576001600160a01b038084166000908152600386016020526040808220548484168352912080546001600160a01b031916919092161790555b50506001600160a01b03166000908152600282016020908152604080832080546001600160a01b03199081169091556003850190925290912080549091169055600101805460ff60a01b198116600160a01b9182900460ff9081166000190116909102179055565b6001600160a01b03808216600081815260038501602052604090205460018501549083169216148062002fcd57506001600160a01b038116155b80620030ae5750816001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b1580156200300e57600080fd5b505afa15801562003023573d6000803e3d6000fd5b505050506040513d60208110156200303a57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0384169163f1cea4c7916004808301926020929190829003018186803b1580156200307d57600080fd5b505afa15801562003092573d6000803e3d6000fd5b505050506040513d6020811015620030a957600080fd5b505111155b15620030bb575062002d9a565b6001600160a01b038083166000818152600286016020526040808220548585168352912080546001600160a01b031916918416919091179055845490911614156200311f5782546001600160a01b0319166001600160a01b03821617835562003161565b6001600160a01b0382811660009081526002850160209081526040808320548416835260038701909152902080546001600160a01b0319169183169190911790555b6001600160a01b038116158015906200324e5750816001600160a01b031663f1cea4c76040518163ffffffff1660e01b815260040160206040518083038186803b158015620031af57600080fd5b505afa158015620031c4573d6000803e3d6000fd5b505050506040513d6020811015620031db57600080fd5b50516040805163f1cea4c760e01b815290516001600160a01b0384169163f1cea4c7916004808301926020929190829003018186803b1580156200321e57600080fd5b505afa15801562003233573d6000803e3d6000fd5b505050506040513d60208110156200324a57600080fd5b5051115b1562003277576001600160a01b0390811660009081526003840160205260409020541662003161565b6001600160a01b038116620032ef576001830180546001600160a01b038481166000818152600288016020908152604080832080549686166001600160a01b031997881617905560038a0190915280822080548616905585549093168152919091208054831682179055825490911617905562000b48565b6001600160a01b0390811660008181526002850160208181526040808420805487168552600390980180835281852080546001600160a01b0319908116998916998a17909155848452895489875283872080549190991690821617909755825283208054861685179055929091529052825416179055565b6000826200337857506000620033c8565b828202828482816200338657fe5b0414620033c55760405162461bcd60e51b815260040180806020018281038252602181526020018062005ed16021913960400191505060405180910390fd5b90505b92915050565b6000620033c583836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250620034b1565b600082820183811015620033c5576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b6000620033c583836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525062003558565b60008183620035415760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b8381101562003505578181015183820152602001620034eb565b50505050905090810190601f168015620035335780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060008385816200354e57fe5b0495945050505050565b60008184841115620035ad5760405162461bcd60e51b815260206004820181815283516024840152835190928392604490910191908501908083836000831562003505578181015183820152602001620034eb565b505050900390565b61282a80620036a783390190565b8280548282559060005260206000209081019282156200361b579160200282015b828111156200361b57825182546001600160a01b0319166001600160a01b03909116178255602090920191600190910190620035e4565b50620036299291506200366e565b5090565b50805460008255906000526020600020908101906200364d91906200368f565b50565b60405180604001604052806002906020820280368337509192915050565b5b80821115620036295780546001600160a01b03191681556001016200366f565b5b808211156200362957600081556001016200369056fe60806040523480156200001157600080fd5b506040516200282a3803806200282a833981810160405260a08110156200003757600080fd5b508051602082015160408301516060840151608090940151929391929091903361f00514620000ad576040805162461bcd60e51b815260206004820152601860248201527f56616c696461746f727320636f6e7472616374206f6e6c790000000000000000604482015290519081900360640190fd5b81836001826001811115620000be57fe5b14156200012257600081118015620000d857506127108111155b6200011c576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b620001ad565b60008111801562000169575062000165600a6200015160036127106200024560201b620021a91790919060201c565b620002ac60201b6200220b1790919060201c565b8111155b620001ad576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600080546301000000600160b81b03191663010000006001600160a01b038a81169190910291909117808355600180546001600160a01b031916928a16929092178255600388905586929161ff0019909116906101009084908111156200021057fe5b02179055506000805484919062ff00001916620100008360038111156200023357fe5b0217905550505050505050506200039d565b6000826200025657506000620002a6565b828202828482816200026457fe5b0414620002a35760405162461bcd60e51b8152600401808060200182810382526021815260200180620028096021913960400191505060405180910390fd5b90505b92915050565b6000620002a383836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250620002f660201b60201c565b60008183620003865760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b838110156200034a57818101518382015260200162000330565b50505050905090810190601f168015620003785780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060008385816200039357fe5b0495945050505050565b61245c80620003ad6000396000f3fe60806040526004361061023b5760003560e01c8063826d3dec1161012e578063ba26d9ff116100ab578063ec0cb3361161006f578063ec0cb33614610290578063f06d5e7714610634578063f1cea4c71461065e578063f3b1cc6714610290578063ff3d9e4f146106735761023b565b8063ba26d9ff146105b1578063c19d93fb146105c6578063c967f90f146105eb578063d0e30db014610617578063e9fad8ee1461061f5761023b565b806397a8ccd5116100f257806397a8ccd5146104f35780639e83d5b1146104fb578063a3ec138d14610510578063a3fbbaae14610569578063a66066791461059c5761023b565b8063826d3dec146104735780638ec7a23d146104885780638f76691a146104b45780639001eed8146104c9578063939d6237146104de5761023b565b8063481c6a75116101bc57806371a1bb751161018057806371a1bb75146103f557806372a11da41461040a578063741579b11461043457806375b94133146104495780638129fc1c1461045e5761023b565b8063481c6a751461035a578063483a00e81461036f5780634df9d6ba14610377578063683c529c146103aa57806370ba1113146103e05761023b565b80632e4f67e4116102035780632e4f67e4146102905780633a5381b5146102cf5780633ccfd60b1461030057806341f4ca621461031757806344f99900146103455761023b565b806303fab4f614610240578063158ef93e1461026757806315de360e1461029057806324c5b1ca146102a55780632b8aba7a146102ba575b600080fd5b34801561024c57600080fd5b5061025561067b565b60408051918252519081900360200190f35b34801561027357600080fd5b5061027c610687565b604080519115158252519081900360200190f35b34801561029c57600080fd5b50610255610690565b3480156102b157600080fd5b50610255610695565b3480156102c657600080fd5b5061025561069b565b3480156102db57600080fd5b506102e46106a1565b604080516001600160a01b039092168252519081900360200190f35b34801561030c57600080fd5b506103156106b7565b005b34801561032357600080fd5b5061032c610805565b6040805192835260208301919091528051918290030190f35b34801561035157600080fd5b506102e461080e565b34801561036657600080fd5b506102e4610814565b610315610823565b34801561038357600080fd5b506102556004803603602081101561039a57600080fd5b50356001600160a01b0316610b05565b3480156103b657600080fd5b506103bf610c2a565b604051808260018111156103cf57fe5b815260200191505060405180910390f35b3480156103ec57600080fd5b50610255610c38565b34801561040157600080fd5b506102e4610c3e565b34801561041657600080fd5b506103156004803603602081101561042d57600080fd5b5035610c44565b34801561044057600080fd5b50610255610f3a565b34801561045557600080fd5b50610255610f46565b34801561046a57600080fd5b50610315610f4c565b34801561047f57600080fd5b50610315611048565b34801561049457600080fd5b50610315600480360360208110156104ab57600080fd5b50351515611203565b3480156104c057600080fd5b5061025561140a565b3480156104d557600080fd5b50610255611410565b3480156104ea57600080fd5b5061025561141c565b610315611422565b34801561050757600080fd5b50610315611587565b34801561051c57600080fd5b506105436004803603602081101561053357600080fd5b50356001600160a01b0316611797565b604080519485526020850193909352838301919091526060830152519081900360800190f35b34801561057557600080fd5b506103156004803603602081101561058c57600080fd5b50356001600160a01b03166117be565b3480156105a857600080fd5b50610315611867565b3480156105bd57600080fd5b50610315611a4a565b3480156105d257600080fd5b506105db611b1b565b604051808260038111156103cf57fe5b3480156105f757600080fd5b50610600611b2a565b6040805161ffff9092168252519081900360200190f35b610315611b2f565b34801561062b57600080fd5b50610315611d89565b34801561064057600080fd5b506103156004803603602081101561065757600080fd5b5035611f0c565b34801561066a57600080fd5b50610255612079565b61031561207f565b671bc16d674ec8000081565b60005460ff1681565b606481565b600b5481565b600a5481565b600054630100000090046001600160a01b031681565b336000908152600760205260409020600301546064906106d890439061224d565b1161071f576040805162461bcd60e51b8152602060048201526012602482015271125b9d195c9d985b081d1bdbc81cdb585b1b60721b604482015290519081900360640190fd5b3360009081526007602052604090206002015461077e576040805162461bcd60e51b815260206004820152601860248201527756616c75652073686f756c64206e6f74206265207a65726f60401b604482015290519081900360640190fd5b33600081815260076020526040808220600281018054908490556003909101839055905190929183156108fc02918491818181858888f193505050501580156107cb573d6000803e3d6000fd5b5060408051828152905133917f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364919081900360200190a250565b60045460055482565b61f00681565b6001546001600160a01b031681565b6001546001600160a01b03163314610879576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b6000805462010000900460ff16600381111561089157fe5b14806108d25750600360005462010000900460ff1660038111156108b157fe5b1480156108d2575060646108d0600a544361224d90919063ffffffff16565b115b610915576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b600b54158061093857506064610936600b544361224d90919063ffffffff16565b115b610984576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b600034116109d4576040805162461bcd60e51b815260206004820152601860248201527756616c75652073686f756c64206e6f74206265207a65726f60401b604482015290519081900360640190fd5b6002546109e1903461228f565b60025560408051348152905133917f278e696bd0cd4a7d1260ced26c40cd01c2b088f441889e4148240ac81069b348919081900360200190a260006001600054610100900460ff166001811115610a3457fe5b1415610a495750670de0b6b3a7640000610a54565b506729a2241af62c00005b8060025410610b02576000805462ff000019166201000017808255604080516363e1d45160e01b815263010000009092046001600160a01b031660048301525161f006926363e1d451926024808201939182900301818387803b158015610aba57600080fd5b505af1158015610ace573d6000803e3d6000fd5b505060005462010000900460ff169150506003811115610aea57fe5b6040516000805160206123e683398151915290600090a25b50565b60408051637a0787a960e11b81523060048201529051600091829161f0059163f40f0f52916024808301926020929190829003018186803b158015610b4957600080fd5b505afa158015610b5d573d6000803e3d6000fd5b505050506040513d6020811015610b7357600080fd5b5051600354909150600090610b979061271090610b919085906121a9565b9061220b565b6008546009549192509015610bde57610bdb81610bd5600954610b91670de0b6b3a7640000610bcf888a61224d90919063ffffffff16565b906121a9565b9061228f565b90505b6001600160a01b038516600090815260076020526040902060018101549054610c219190610c1b90670de0b6b3a764000090610b919086906121a9565b9061224d565b95945050505050565b600054610100900460ff1681565b60035481565b61f00581565b60008111610c94576040805162461bcd60e51b815260206004820152601860248201527756616c75652073686f756c64206e6f74206265207a65726f60401b604482015290519081900360640190fd5b33600090815260076020526040902054811115610cee576040805162461bcd60e51b8152602060048201526013602482015272125b9cdd59999a58da595b9d08185b5bdd5b9d606a1b604482015290519081900360640190fd5b61f0056001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610d2b57600080fd5b505af1158015610d3f573d6000803e3d6000fd5b505033600090815260076020526040812060018101549054600854929450610d7b93509091610c1b91670de0b6b3a764000091610b91916121a9565b600954909150610d8b908361224d565b60095533600090815260076020526040902054610da8908361224d565b336000908152600760205260409020819055600854610dd591670de0b6b3a764000091610b9191906121a9565b33600090815260076020526040902060019081019190915560005462010000900460ff166003811115610e0457fe5b1415610e605761f0056001600160a01b031663bb8b65af6040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610e4757600080fd5b505af1158015610e5b573d6000803e3d6000fd5b505050505b33600090815260076020526040902060020154610e7d908361228f565b336000818152600760205260408082206002810194909455436003909401939093559151909183156108fc02918491818181858888f19350505050158015610ec9573d6000803e3d6000fd5b5060408051838152905133917f41b45db803eded5e27cdf3cbba5707b3575e9b6959de41c3f7b83b51ce600502919081900360200190a260408051828152905133917f7cddc560d4de1ea9d83e4123f01e6072afc503bb47bcc765f0396ba3861a0454919081900360200190a25050565b670de0b6b3a764000081565b60065481565b3361f00514610f9d576040805162461bcd60e51b815260206004820152601860248201527756616c696461746f727320636f6e7472616374206f6e6c7960401b604482015290519081900360640190fd5b60005460ff1615610feb576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b6000805460ff191660011781556040805163136ec0b360e01b8152905161f0059263136ec0b3926004808201939182900301818387803b15801561102e57600080fd5b505af1158015611042573d6000803e3d6000fd5b50505050565b3361f00614611095576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b43600a55600260005462010000900460ff1660038111156110b257fe5b146110f6576000805462ff0000191662030000179081905562010000900460ff1660038111156110de57fe5b6040516000805160206123e683398151915290600090a25b61f0056001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561113357600080fd5b505af1158015611147573d6000803e3d6000fd5b505050506000671bc16d674ec80000600254101561116757600254611171565b671bc16d674ec800005b90508015610b0257600254611186908261224d565b60025560405160009082156108fc0290839083818181858288f193505050501580156111b6573d6000803e3d6000fd5b5060005460408051838152905163010000009092046001600160a01b0316917febbcaaf6b9aa8b4083ae4b2f842c8de6f75319018e7b5e141a1e87aebadde6c3916020908290030190a250565b3361f00514611254576040805162461bcd60e51b815260206004820152601860248201527756616c696461746f727320636f6e7472616374206f6e6c7960401b604482015290519081900360640190fd5b801561136f576000805462010000900460ff16600381111561127257fe5b14806112945750600160005462010000900460ff16600381111561129257fe5b145b6112d7576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6000805462ff0000191662020000179081905562010000900460ff1660038111156112fe57fe5b6040516000805160206123e683398151915290600090a261f0056001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561135257600080fd5b505af1158015611366573d6000803e3d6000fd5b50505050610b02565b600260005462010000900460ff16600381111561138857fe5b146113cc576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6000805462ff000019169081905562010000900460ff1660038111156113ee57fe5b6040516000805160206123e683398151915290600090a2610b02565b60025481565b6729a2241af62c000081565b60085481565b6001546001600160a01b03163314611478576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b61f0056001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156114b557600080fd5b505af11580156114c9573d6000803e3d6000fd5b50505050600060065411611515576040805162461bcd60e51b815260206004820152600e60248201526d139bc81b5bdc99481c995dd85c9960921b604482015290519081900360640190fd5b600680546000918290556040519091339183156108fc0291849190818181858888f1935050505015801561154d573d6000803e3d6000fd5b5060408051828152905133917fe4fc75e2b70d2f179fc77c722f2334ba1507c59932576ec9620b15dfb06d91e2919081900360200190a250565b6001546001600160a01b031633146115dd576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b6000805462010000900460ff1660038111156115f557fe5b14806116365750600360005462010000900460ff16600381111561161557fe5b14801561163657506064611634600a544361224d90919063ffffffff16565b115b611679576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b6064611690600b544361224d90919063ffffffff16565b116116dd576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b600060025411611725576040805162461bcd60e51b815260206004820152600e60248201526d27379036b7b9329036b0b933b4b760911b604482015290519081900360640190fd5b600280546000918290556040519091339183156108fc0291849190818181858888f1935050505015801561175d573d6000803e3d6000fd5b5060408051828152905133917f5d3b8fa9823b18b176cfe79e002a5b931b8569313802f700eb8550bc6a353246919081900360200190a250565b60076020526000908152604090208054600182015460028301546003909301549192909184565b600054630100000090046001600160a01b0316331461181d576040805162461bcd60e51b815260206004820152601660248201527513db9b1e481d985b1a59185d1bdc88185b1b1bddd95960521b604482015290519081900360640190fd5b600180546001600160a01b0319166001600160a01b0383169081179091556040517f5cd5185727f6057b7a274979ce4d902e15bf0ef1dc542d1fe5926cba874f63b690600090a250565b6001546001600160a01b031633146118bd576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b60005460045461010090910460ff169060018260018111156118db57fe5b141561193b576000811180156118f357506127108111155b611936576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b61199f565b60008111801561195c5750611958600a610b9161271060036121a9565b8111155b61199f576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b600554158015906119be57506005546064906119bc90439061224d565b115b611a0a576040805162461bcd60e51b8152602060048201526018602482015277092dce8cae4ecc2d840dcdee840d8dedcce40cadcdeeaced60431b604482015290519081900360640190fd5b600480546003819055600091829055600582905560405190917f450a792501c47863e89114cbdd0497acb22d4abfc51dc315afc323c5ba92d4a991a25050565b3361f00614611a97576040805162461bcd60e51b815260206004820152601460248201527350756e69736820636f6e7472616374206f6e6c7960601b604482015290519081900360640190fd5b6006805460009182905560405190919082156108fc0290839083818181858288f19350505050158015611ace573d6000803e3d6000fd5b5060005460408051838152905163010000009092046001600160a01b0316917f0a3c8b346f3f7fe5668c9f575473491c4274339e10c9548d7995f22211f988f0916020908290030190a250565b60005462010000900460ff1681565b600581565b61f0056001600160a01b031663c885bc586040518163ffffffff1660e01b8152600401600060405180830381600087803b158015611b6c57600080fd5b505af1158015611b80573d6000803e3d6000fd5b505033600090815260076020526040812060018101549054600854929450611bbc93509091610c1b91670de0b6b3a764000091610b91916121a9565b90503415611cde5733600090815260076020526040902054611bde903461228f565b336000908152600760205260409020819055600854611c0b91670de0b6b3a764000091610b9191906121a9565b33600090815260076020526040902060010155600954611c2b903461228f565b60095560408051348152905133917fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c919081900360200190a2600160005462010000900460ff166003811115611c7d57fe5b1415611cd95761f0056001600160a01b031663136ec0b36040518163ffffffff1660e01b8152600401600060405180830381600087803b158015611cc057600080fd5b505af1158015611cd4573d6000803e3d6000fd5b505050505b611d1c565b60085433600090815260076020526040902054611d0891670de0b6b3a764000091610b91916121a9565b336000908152600760205260409020600101555b8015610b0257604051339082156108fc029083906000818181858888f19350505050158015611d4f573d6000803e3d6000fd5b5060408051828152905133917f7cddc560d4de1ea9d83e4123f01e6072afc503bb47bcc765f0396ba3861a0454919081900360200190a250565b6001546001600160a01b03163314611ddf576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b600160005462010000900460ff166003811115611df857fe5b14611e3c576040805162461bcd60e51b815260206004820152600f60248201526e496e636f727265637420737461746560881b604482015290519081900360640190fd5b43600b556000805462ff000019169081905562010000900460ff166003811115611e6257fe5b6040516000805160206123e683398151915290600090a261f0056001600160a01b03166371df76786040518163ffffffff1660e01b8152600401600060405180830381600087803b158015611eb657600080fd5b505af1158015611eca573d6000803e3d6000fd5b50506000805460405163010000009091046001600160a01b031693507f7c79e6e24ed041d1072d54523b53956f01b91b835f0490856370594d9d14470e9250a2565b6001546001600160a01b03163314611f62576040805162461bcd60e51b815260206004820152601460248201527313db9b1e481b585b9859d95c88185b1b1bddd95960621b604482015290519081900360640190fd5b600054610100900460ff16816001826001811115611f7c57fe5b1415611fdc57600081118015611f9457506127108111155b611fd7576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b612040565b600081118015611ffd5750611ff9600a610b9161271060036121a9565b8111155b612040576040805162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081c195c98d95b9d608a1b604482015290519081900360640190fd5b60048390554360055560405183907f2dcbffddb492dea86de0b18dac6d71f51a7b7a5ec946512e0c993a050f3b48ea90600090a2505050565b60095481565b3361f005146120d0576040805162461bcd60e51b815260206004820152601860248201527756616c696461746f727320636f6e7472616374206f6e6c7960401b604482015290519081900360640190fd5b60006120ed612710610b91600354346121a990919063ffffffff16565b6006549091506120fd908261228f565b6006556009541561213757612133600854610bd5600954610b91670de0b6b3a7640000610bcf873461224d90919063ffffffff16565b6008555b4761215b670de0b6b3a7640000610b916009546008546121a990919063ffffffff16565b600654011115610b02576040805162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b604482015290519081900360640190fd5b6000826121b857506000612205565b828202828482816121c557fe5b04146122025760405162461bcd60e51b81526004018080602001828103825260218152602001806124066021913960400191505060405180910390fd5b90505b92915050565b600061220283836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f0000000000008152506122e9565b600061220283836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525061238b565b600082820183811015612202576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b600081836123755760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561233a578181015183820152602001612322565b50505050905090810190601f1680156123675780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b50600083858161238157fe5b0495945050505050565b600081848411156123dd5760405162461bcd60e51b815260206004820181815283516024840152835190928392604490910191908501908083836000831561233a578181015183820152602001612322565b50505090039056fe402ee26d4c255fcb07b0b7b5b93b77377832260977c25be44f3c8feffd2df70e536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a2646970667358221220573bcffeb57b4a17be6e999635dc4babbe0baaecab61027ad60d8bafb7e8dbb064736f6c634300060c0033536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77436f72726573706f6e64696e6720766f746520706f6f6c206e6f7420666f756e64a264697066735822122015d6a5ac4c83a47c53c87af72a0c4230d18d9fe4e11e7506b3684e33ae5b800d64736f6c634300060c0033"
)

type hardForkValidatorsV1 struct {
}

func (s *hardForkValidatorsV1) GetName() string {
	return ValidatorsV1ContractName
}

func (s *hardForkValidatorsV1) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(validatorV1Code)

	//write code to sys contract
	state.SetCode(ValidatorsV1ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", ValidatorsV1ContractAddr.String(), "code", validatorV1Code)

	return
}

func (s *hardForkValidatorsV1) getAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return validatorV1Admin
	}

	return validatorV1AdminTestnet
}

func (s *hardForkValidatorsV1) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	//First, get top validators from the old contract
	v0 := NewValidatorV0()
	topVals, err := v0.GetTopValidators(state, header, chainContext, config)
	if err != nil {
		log.Error("getTopValidators from V0 failed", "err", err)
		return err
	}
	managers := make([]common.Address, 0, len(topVals))
	for _, val := range topVals {
		feeAddr, err := v0.GetValidatorFeeAddr(val, state, header, chainContext, config)
		if err != nil {
			return err
		}
		managers = append(managers, feeAddr)
	}

	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[ValidatorsV1ContractName].Pack(method, topVals, managers, s.getAdminByChainId(config.ChainID))
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := types.NewMessage(header.Coinbase, &ValidatorsV1ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
